<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>WebAR â€“ Image Tracking (MindAR + A-Frame)</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  <style>
    :root { color-scheme: dark; }
    html,body{ margin:0; height:100%; background:#000; font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
    .hud{ position:fixed; left:50%; transform:translateX(-50%); z-index:3; }
    #start{ bottom:84px; background:#111; border:1px solid #333; color:#fff; padding:10px 14px; border-radius:12px; }
    #tip{ bottom:48px; color:#bbb; font-size:12px; }
    #log{ position:fixed; right:10px; bottom:10px; max-width:60vw; background:rgba(0,0,0,.6); color:#fff; padding:8px 10px; border-radius:10px; font:12px/1.3 system-ui; z-index:3; white-space:pre-wrap }
    #target{ position:fixed; right:10px; top:10px; z-index:3; background:#111; border:1px solid #222; border-radius:10px; padding:6px }
  </style>
</head>
<body>
  <button id="start" class="hud">ðŸš€ AR starten</button>
  <div id="tip" class="hud">Erlaube Kamera-Zugriff â€¢ Tippe zum Start</div>
  <div id="log"></div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png" width="120" height="66"/>
  </div>

  <a-scene
    mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false;"
    vr-mode-ui="enabled:false"
    device-orientation-permission-ui="enabled:false"
    renderer="colorManagement:true, physicallyCorrectLights"
    embedded
    >
    <a-assets>
      <a-asset-item id="model" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
    </a-assets>

    <!-- A-Frame Kamera bleibt, Look-Controls aus -->
    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity mindar-image-target="targetIndex:0">
      <a-gltf-model src="#model" position="0 0 0.1" scale="0.005 0.005 0.005"
        animation="property: position; to: 0 0.08 0.1; dur:900; dir:alternate; loop:true; easing:easeInOutQuad"></a-gltf-model>
    </a-entity>
  </a-scene>

  <script>
    const $ = (s)=>document.querySelector(s);
    const log = (m)=>{ const el=$('#log'); el.textContent = (el.textContent?el.textContent+'\n':'') + m; };

    // Hilfsevent-Logs
    const scene = document.querySelector('a-scene');
    scene.addEventListener('arReady', ()=> log('âœ… MindAR bereit'));
    scene.addEventListener('arError', e=> log('âŒ MindAR Fehler: ' + (e?.detail || 'unbekannt')));

    // Tap-to-start: Start erst nach User-Geste
    $('#start').addEventListener('click', async ()=>{
      try{
        // Versuch, explizit Rear-Cam zu erzwingen (falls Browser es supportet)
        const sys = scene.systems['mindar-image-system'];
        // MindAR kÃ¼mmert sich intern um getUserMedia; Start call reicht i.d.R.:
        await sys.start();
        $('#start').style.display='none';
        $('#tip').textContent = 'Scanne die Karte';
        log('ðŸŽ¥ Kamera gestartet');
      }catch(err){
        log('âŒ Start-Fehler: '+ err.message);
        if(err.name === 'NotAllowedError') log('Hinweis: PrÃ¼fe Website-Einstellungen â†’ Kamera â€žZulassenâ€œ.');
        if(err.name === 'NotFoundError') log('Hinweis: Keine Kamera gefunden. Andere App nutzt evtl. die Kamera?');
      }
    });

    // Zusatz: PrÃ¼fen, ob Kamera-Rechte wirklich erlaubt sind
    if(navigator.permissions && navigator.permissions.query){
      navigator.permissions.query({name:'camera'}).then(p=> log('ðŸ”’ Camera-Permission: ' + p.state)).catch(()=>{});
    }
  </script>
</body>
</html>
