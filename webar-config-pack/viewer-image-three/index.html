<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR â€“ Image (MindAR UMD, single THREE)</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:80px;transform:translateX(-50%);z-index:3;display:flex;gap:8px}
    button{background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:12px}
    #log{position:fixed;right:10px;bottom:10px;max-width:70vw;background:rgba(0,0,0,.6);color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.3 system-ui;white-space:pre-wrap;z-index:3}
    #target{position:fixed;right:10px;top:10px;z-index:3;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
  </style>
  <!-- Nur die MindAR-UMD (liefert window.MINDAR.IMAGE & eigene THREE-Instanz) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="ui">
    <button id="start">ðŸš€ AR starten</button>
    <button id="retry" style="display:none">ðŸ”„ Neu versuchen</button>
  </div>
  <div id="log"></div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img id="targetImg" width="140"/>
  </div>

  <script>
    const log = (m)=>{ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; };
    let mindar = null;

    async function loadConfig(){
      const qs = new URLSearchParams(location.search);
      const url = qs.get('project');
      if(!url){
        return {
          anchor:{ type:"image", targets:[{
            src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind",
            preview:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
          }]},
          nodes:[{ id:"cube", transform:{ position:[0,0,0.1], rotation:[0,0,0], scale:[0.15,0.15,0.15] } }]
        };
      }
      const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error('Config '+r.status);
      return r.json();
    }

    async function startAR(){
      try{
        document.getElementById('start').disabled = true;
        document.getElementById('retry').style.display = 'none';

        const M = window.MINDAR?.IMAGE;
        if(!M?.MindARThree) throw new Error('MindAR UMD nicht geladen');
        const { MindARThree, THREE } = M;

        const cfg = await loadConfig();
        const t = cfg.anchor?.targets?.[0]; if(!t?.src) throw new Error('anchor.targets[0].src (.mind) fehlt');
        if(t.preview){ target.style.display='block'; targetImg.src=t.preview; }

        // Vorherige Session sauber stoppen (falls vorhanden)
        if(mindar){ try{ await mindar.stop(); }catch{} mindar = null; }

        mindar = new MindARThree({
          container: document.body, imageTargetSrc: t.src,
          uiLoading:true, uiError:true, maxTrack:1
        });
        const { renderer, scene, camera } = mindar;

        renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
        scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

        const anchor = mindar.addAnchor(0);
        const cube = new THREE.Mesh(
          new THREE.BoxGeometry(1,1,1),
          new THREE.MeshStandardMaterial({metalness:0.1, roughness:0.6})
        );
        const n = (cfg.nodes||[])[0] || {};
        const p = n.transform?.position || [0,0,0.1];
        const r = n.transform?.rotation || [0,0,0];
        const s = n.transform?.scale    || [0.15,0.15,0.15];
        cube.position.set(...p); cube.rotation.set(...r); cube.scale.set(...s);
        anchor.group.add(cube);

        await mindar.start();             // <- hier holt MindAR die Kamera
        const v = mindar.video; if(v) log(`ðŸ“¹ ${v.videoWidth}x${v.videoHeight}`);
        log('âœ… MindAR gestartet');
        renderer.setAnimationLoop(()=> renderer.render(scene, camera));
      }catch(e){
        log('âŒ '+(e?.name||'')+' '+(e?.message||e));
        if(String(e).includes('NotReadableError')){
          log('â„¹ï¸ Kamera ist belegt (anderer Tab/App). SchlieÃŸe den Surface-Viewer/andere Kamera-Apps und tippe â€žNeu versuchenâ€œ.');
          document.getElementById('retry').style.display = 'inline-block';
        }
        document.getElementById('start').disabled = false;
      }
    }

    document.getElementById('start').onclick = startAR;
    document.getElementById('retry').onclick = startAR;

    // Sicherheitsnetz: Wenn die Seite versteckt wird, AR stoppen (gibt Kamera frei)
    document.addEventListener('visibilitychange', async ()=>{
      if(document.hidden && mindar){
        try{ await mindar.stop(); }catch{}
      }
    });
    window.addEventListener('pagehide', async ()=>{ if(mindar){ try{ await mindar.stop(); }catch{} }});
  </script>
</body>
</html>
