<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>WebAR â€“ Image (MindAR mit Kamera-Wahl)</title>
  <style>
    :root{color-scheme:dark}
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    #ui{position:fixed;left:50%;bottom:70px;transform:translateX(-50%);z-index:3;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    button{background:#111;border:1px solid #333;color:#fff;padding:10px 14px;border-radius:12px}
    #log{position:fixed;right:10px;bottom:10px;max-width:80vw;background:rgba(0,0,0,.6);color:#fff;padding:8px 10px;border-radius:10px;font:12px/1.35 system-ui;white-space:pre-wrap;z-index:3}
    #picker{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:3;background:#111;border:1px solid #333;color:#ddd;border-radius:12px;padding:8px 10px;display:none;max-width:92vw}
    #picker label{display:block;margin:6px 0 4px;color:#aaa;font-size:12px}
    #picker select{width:72vw;max-width:520px;background:#0b0b0b;border:1px solid #333;color:#fff;border-radius:10px;padding:8px}
    #target{position:fixed;right:10px;top:10px;z-index:3;background:#111;border:1px solid #222;border-radius:10px;padding:6px;display:none}
  </style>

  <!-- Nur MindAR-UMD laden (liefert window.MINDAR.IMAGE + eigene THREE) -->
  <script src="https://unpkg.com/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
</head>
<body>
  <div id="ui">
    <button id="start">ðŸš€ AR starten</button>
    <button id="pick">ðŸŽ¥ Kamera wÃ¤hlen</button>
    <button id="retry" style="display:none">ðŸ”„ Neu versuchen</button>
  </div>

  <div id="picker">
    <label for="cams">Kamera</label>
    <select id="cams"></select>
    <button id="useCam" style="margin-left:8px">Ãœbernehmen</button>
  </div>

  <div id="log"></div>
  <div id="target">
    <div style="color:#bbb;font:12px/1.2 system-ui;margin-bottom:4px">Target Preview:</div>
    <img id="targetImg" width="140"/>
  </div>

<script>
const log = (m)=>{ const el=document.getElementById('log'); el.textContent += (el.textContent?'\n':'') + m; };

// â€”â€”â€”â€”â€” Kamera-Auswahl (UI & Speicherung) â€”â€”â€”â€”â€”
async function ensureLabels(){
  // Labels sind oft leer bis einmalige Permission erteilt wurde:
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:true});
    s.getTracks().forEach(t=>t.stop());
  }catch{} // ignorieren (wenn bereits erlaubt)
}
async function listCameras(){
  const devices = (await navigator.mediaDevices.enumerateDevices()).filter(d=>d.kind==='videoinput');
  // leichte Heuristik: "back", "rear" nach vorne
  devices.sort((a,b)=>{
    const ra = /back|rear|environment/i.test(a.label)?-1:0;
    const rb = /back|rear|environment/i.test(b.label)?-1:0;
    return ra - rb;
  });
  return devices;
}
async function showPicker(){
  await ensureLabels();
  const cams = await listCameras();
  const sel  = document.getElementById('cams');
  sel.innerHTML = '';
  const current = localStorage.getItem('webar.cameraId') || '';
  cams.forEach(d=>{
    const o = document.createElement('option');
    o.value = d.deviceId;
    o.textContent = d.label || `Kamera ${d.deviceId.slice(0,6)}â€¦`;
    if(d.deviceId===current) o.selected = true;
    sel.appendChild(o);
  });
  document.getElementById('picker').style.display='block';
}
document.getElementById('pick').onclick = showPicker;
document.getElementById('useCam').onclick = ()=>{
  const id = document.getElementById('cams').value;
  if(id){ localStorage.setItem('webar.cameraId', id); log('âœ… Kamera gesetzt: '+document.getElementById('cams').selectedOptions[0].textContent); }
  document.getElementById('picker').style.display='none';
};

// â€”â€”â€”â€” getUserMedia einmalig â€žpatchenâ€œ, um deviceId zu erzwingen â€”â€”â€”â€”
function forceNextGetUserMediaToUse(deviceId){
  const orig = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
  let used = false;
  navigator.mediaDevices.getUserMedia = (constraints)=>{
    try{
      if(!used && constraints && 'video' in constraints){
        const v = constraints.video;
        const vObj = (typeof v==='object' && v!==null) ? {...v} : {};
        // deviceId exakt setzen â€“ Browser nimmt diese Kamera
        vObj.deviceId = { exact: deviceId };
        constraints = {...constraints, video: vObj};
        used = true;
      }
    }catch{}
    const p = orig(constraints);
    // nach der ersten Verwendung automatisch zurÃ¼cksetzen
    p.finally(()=>{ navigator.mediaDevices.getUserMedia = orig; });
    return p;
  };
}

// â€”â€”â€”â€”â€” MindAR-Start mit robuster Fehlerbehandlung â€”â€”â€”â€”â€”
let mindar = null;
async function loadConfig(){
  const qs = new URLSearchParams(location.search);
  const url = qs.get('project');
  if(!url){
    return {
      anchor:{ type:"image", targets:[{
        src:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind",
        preview:"https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png"
      }]},
      nodes:[{ id:"cube", transform:{ position:[0,0,0.1], rotation:[0,0,0], scale:[0.15,0.15,0.15] } }]
    };
  }
  const r = await fetch(url, {cache:'no-store'}); if(!r.ok) throw new Error('Config '+r.status);
  return r.json();
}

async function startAR(){
  try{
    document.getElementById('start').disabled = true;
    document.getElementById('retry').style.display = 'none';

    const M = window.MINDAR?.IMAGE;
    if(!M?.MindARThree) throw new Error('MindAR UMD nicht geladen');
    const { MindARThree, THREE } = M;

    const cfg = await loadConfig();
    const t = cfg.anchor?.targets?.[0];
    if(!t?.src) throw new Error('anchor.targets[0].src (.mind) fehlt');
    if(t.preview){ target.style.display='block'; targetImg.src=t.preview; }

    // vorherige Session freigeben
    if(mindar){ try{ await mindar.stop(); }catch{} mindar = null; }

    // gewÃ¼nschte Kamera fÃ¼r den nÃ¤chsten getUserMedia()-Call erzwingen
    const pref = localStorage.getItem('webar.cameraId');
    if(pref){ forceNextGetUserMediaToUse(pref); }

    mindar = new MindARThree({ container: document.body, imageTargetSrc: t.src, uiLoading:true, uiError:true, maxTrack:1 });
    const { renderer, scene, camera } = mindar;

    renderer.setPixelRatio(Math.min(devicePixelRatio||1, 2));
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));

    const anchor = mindar.addAnchor(0);
    const cube = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), new THREE.MeshStandardMaterial({metalness:0.1, roughness:0.6}));
    const n = (cfg.nodes||[])[0] || {};
    const p = n.transform?.position || [0,0,0.1];
    const r = n.transform?.rotation || [0,0,0];
    const s = n.transform?.scale    || [0.15,0.15,0.15];
    cube.position.set(...p); cube.rotation.set(...r); cube.scale.set(...s);
    anchor.group.add(cube);

    await mindar.start();
    const v = mindar.video; if(v) log(`ðŸ“¹ ${v.videoWidth}x${v.videoHeight}`);
    log('âœ… MindAR gestartet');

    renderer.setAnimationLoop(()=> renderer.render(scene, camera));
  }catch(e){
    log('âŒ '+(e?.name||'')+' '+(e?.message||e));
    if(String(e).includes('NotReadableError') || String(e).includes('Device in use')){
      log('â„¹ï¸ Kamera belegt. SchlieÃŸe andere Kamera-/AR-Seiten (z.B. Surface) und tippe â€žNeu versuchenâ€œ.');
      document.getElementById('retry').style.display = 'inline-block';
    }
    document.getElementById('start').disabled = false;
  }
}

document.getElementById('start').onclick = startAR;
document.getElementById('retry').onclick = startAR;

// Wenn Tab versteckt wird, Kamera freigeben
document.addEventListener('visibilitychange', async ()=>{
  if(document.hidden && mindar){ try{ await mindar.stop(); }catch{} }
});
window.addEventListener('pagehide', async ()=>{ if(mindar){ try{ await mindar.stop(); }catch{} }});
</script>
</body>
</html>
