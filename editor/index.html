<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mini‑Editor – WebAR Starter</title>
  <style>
    html,body{margin:0;height:100%;background:#0f1220;color:#e8eefc;font-family:system-ui;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;gap:12px;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,.1);background:#0b0d18}
    input[type="text"]{width:36ch;max-width:58vw;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#0e1325;color:#e8eefc}
    button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:#171b2d;color:#fff}
    #viewer{position:relative}
    canvas{display:block;width:100%;height:100%}
    #overlay{position:absolute;left:12px;bottom:12px;opacity:.85;background:rgba(0,0,0,.35);padding:8px 10px;border-radius:8px}
    select{padding:6px;border-radius:8px;background:#0e1325;color:#fff;border:1px solid rgba(255,255,255,.2)}
    label{opacity:.85}
  </style>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <script type="module">
    import * as THREE from 'three';
    import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
    import {TransformControls} from 'three/addons/controls/TransformControls.js';
    import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';

    let scene, camera, renderer, orbit, transform, model=null, mixer=null, animations=[], activeAnim=null;

    function init(){
      const container = document.getElementById('viewer');
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b0d18);

      camera = new THREE.PerspectiveCamera(50, container.clientWidth/container.clientHeight, 0.1, 100);
      camera.position.set(3, 2, 4);

      renderer = new THREE.WebGLRenderer({antialias:true});
      renderer.setPixelRatio(devicePixelRatio);
      renderer.setSize(container.clientWidth, container.clientHeight);
      container.appendChild(renderer.domElement);

      const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.0);
      scene.add(hemi);
      const dir = new THREE.DirectionalLight(0xffffff, 1.0);
      dir.position.set(5,10,7);
      scene.add(dir);

      // Grid + plane
      const grid = new THREE.GridHelper(10, 20, 0x3856ff, 0x1f284d);
      grid.material.opacity = 0.3; grid.material.transparent = true;
      scene.add(grid);

      orbit = new OrbitControls(camera, renderer.domElement);
      orbit.target.set(0,0,0);
      orbit.update();

      transform = new TransformControls(camera, renderer.domElement);
      transform.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
      scene.add(transform);

      window.addEventListener('resize', ()=> {
        renderer.setSize(container.clientWidth, container.clientHeight);
        camera.aspect = container.clientWidth/container.clientHeight; camera.updateProjectionMatrix();
      });

      animate();
    }

    function animate(){
      requestAnimationFrame(animate);
      if (mixer) mixer.update(1/60);
      renderer.render(scene,camera);
    }

    function clearModel(){
      if (model){ scene.remove(model); model.traverse(o=>{ if(o.geometry) o.geometry.dispose(); if(o.material) Array.isArray(o.material)?o.material.forEach(m=>m.dispose()):o.material.dispose(); }); model=null; }
      if (mixer){ mixer.stopAllAction(); mixer = null; }
      animations = []; activeAnim = null;
      document.getElementById('anim').innerHTML = '<option value="">(keine)</option>';
    }

    async function loadGLB(url){
      const loader = new GLTFLoader();
      return new Promise((resolve,reject)=>{
        loader.load(url, (gltf)=>{
          resolve(gltf);
        }, undefined, reject);
      });
    }

    // --- Anchor-UI toggeln ---
function updateAnchorUI(){
  const m = document.getElementById('anchorMode').value;
  document.getElementById('row-image').style.display  = (m === 'image')  ? '' : 'none';
  document.getElementById('row-native').style.display = (m === 'native') ? '' : 'none';
}

// --- Editor-Transform in Query umwandeln ---
function buildTransformQuery(){
  const q = new URLSearchParams();
  if (model){
    // Position
    q.set('px', model.position.x.toFixed(6));
    q.set('py', model.position.y.toFixed(6));
    q.set('pz', model.position.z.toFixed(6));
    // Rotation (RAD)
    q.set('rx', model.rotation.x.toFixed(6));
    q.set('ry', model.rotation.y.toFixed(6));
    q.set('rz', model.rotation.z.toFixed(6));
    // Scale (XYZ)
    q.set('sx', model.scale.x.toFixed(6));
    q.set('sy', model.scale.y.toFixed(6));
    q.set('sz', model.scale.z.toFixed(6));
  }
  // Animation-Index (falls gesetzt)
  const idx = document.getElementById('anim').value;
  if (idx !== "") q.set('anim', idx);
  return q.toString();
}

// --- Veröffentlichen: öffnet deine Modul-Seiten über HTTPS (jsDelivr) ---
function publishFromEditor(){
  const glbUrl = document.getElementById('url').value.trim();
  if (!glbUrl){ alert('Bitte zuerst ein GLB laden oder die GLB-URL eintragen.'); return; }

  const mode   = document.getElementById('anchorMode').value;
  const target = document.getElementById('imageTarget').value.trim();
  const usdz   = document.getElementById('usdzUrl').value.trim();

  // Deine Modulpfade im Repo (HTTPS, funktioniert überall)
  const BASE = {
    'surface-webxr': 'https://cdn.jsdelivr.net/gh/KrischiHH/area@main/surface-ar/webxr.html',
    'native':        'https://cdn.jsdelivr.net/gh/KrischiHH/area@main/surfaces-ar/surface-viewer.html',
    'image':         'https://cdn.jsdelivr.net/gh/KrischiHH/area@main/image-ar/viewer.html'
  };

  // Grund-URL + GLB
  let url = `${BASE[mode]}?glb=${encodeURIComponent(glbUrl)}`;

  // Transform/Anim aus dem Editor anhängen
  const tqs = buildTransformQuery();
  if (tqs) url += `&${tqs}`;

  // Modus-spezifische Parameter
  if (mode === 'image'){
    if (!target){ alert('Bitte Target (.mind) angeben.'); return; }
    url += `&target=${encodeURIComponent(target)}`;
  }
  if (mode === 'native'){
    if (usdz) url += `&usdz=${encodeURIComponent(usdz)}`; // iOS Quick Look
    // (Android Scene Viewer nutzt das glb= bereits)
  }

  // Öffnen
  window.open(url, '_blank');
}


    document.addEventListener('DOMContentLoaded', ()=>{
      init();

      document.getElementById('load').addEventListener('click', async ()=>{
        const url = document.getElementById('url').value.trim();
        if(!url){ alert('Bitte GLB-URL angeben (oder lade ein Modell in /assets/models).'); return; }
        try{
          clearModel();
          const gltf = await loadGLB(url);
          model = gltf.scene;
          model.position.set(0,0,0);
          model.scale.set(1,1,1);
          scene.add(model);
          transform.attach(model);

          // Animations
          if (gltf.animations && gltf.animations.length){
            mixer = new THREE.AnimationMixer(model);
            animations = gltf.animations;
            const sel = document.getElementById('anim');
            sel.innerHTML = '<option value="">(Pause)</option>' + animations.map((a,i)=>`<option value="${i}">${a.name||'Animation '+i}</option>`).join('');
          }
        }catch(e){
          console.error(e);
          alert('Fehler beim Laden. Prüfe die URL (CORS) oder das Modell.');
        }
      });

      document.getElementById('anim').addEventListener('change', e=>{
        if(!mixer) return;
        mixer.stopAllAction();
        const idx = e.target.value;
        if (idx === "") return;
        const clip = animations[Number(idx)];
        const action = mixer.clipAction(clip);
        action.reset().play();
      });

      document.getElementById('mode-translate').addEventListener('click', ()=> transform.setMode('translate'));
      document.getElementById('mode-rotate').addEventListener('click', ()=> transform.setMode('rotate'));
      document.getElementById('mode-scale').addEventListener('click', ()=> transform.setMode('scale'));

      updateAnchorUI(); // initiale Sichtbarkeit
document.getElementById('anchorMode').addEventListener('change', updateAnchorUI);
document.getElementById('publish').addEventListener('click', publishFromEditor);


      document.getElementById('export').addEventListener('click', ()=>{
        const data = {
          modelUrl: document.getElementById('url').value.trim(),
          position: model ? {x:model.position.x, y:model.position.y, z:model.position.z} : {x:0,y:0,z:0},
          rotation: model ? {x:model.rotation.x, y:model.rotation.y, z:model.rotation.z} : {x:0,y:0,z:0},
          scale: model ? {x:model.scale.x, y:model.scale.y, z:model.scale.z} : {x:1,y:1,z:1},
          animationIndex: document.getElementById('anim').value || null
        };
        const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'scene.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });
    });
  </script>
</head>
<body>
  <header>
    <label>GLB‑URL:&nbsp;<input id="url" type="text" placeholder="https://…/model.glb" value="https://modelviewer.dev/shared-assets/models/Astronaut.glb"/></label>
    <button id="load">Laden</button>
    <label>Animation:&nbsp;<select id="anim"><option value="">(keine)</option></select></label>
    <button id="mode-translate">Move</button>
    <button id="mode-rotate">Rotate</button>
    <button id="mode-scale">Scale</button>
    <button id="export">Export scene.json</button>
    
    <!-- Anchor-Auswahl + Publish -->
<label>Modus:&nbsp;
  <select id="anchorMode">
    <option value="surface-webxr" selected>Surface (WebXR)</option>
    <option value="image">Image Trigger</option>
    <option value="native">Surface (Native)</option>
  </select>
</label>

<!-- nur für Image Trigger -->
<label id="row-image" style="display:none">Target (.mind):&nbsp;
  <input id="imageTarget" type="text"
         value="https://cdn.jsdelivr.net/gh/KrischiHH/area@main/assets/targets/target.mind"
         placeholder="https://…/target.mind">
</label>

<!-- nur für Native -->
<label id="row-native" style="display:none">USDZ (iOS):&nbsp;
  <input id="usdzUrl" type="text" placeholder="https://…/model.usdz">
</label>

<button id="publish">Veröffentlichen</button>

  </header>
  <div id="viewer"></div>
  <div id="overlay">Tipp: Lege eigene Modelle unter <code>/assets/models/</code> ab (GitHub Pages URL verwenden).</div>
</body>
</html>
