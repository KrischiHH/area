<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WebAR Editor v2.2.4</title>
  <style>
    :root{
      --bg:#0e1116;--panel:#111828;--panel2:#192339;--text:#e9ecf5;--muted:#9fb3d9;--border:#24314a;--accent:#60a5fa;--accent2:#93c5fd;
      color-scheme: dark;
    }
    /* Eingestanzte Pill (reine Vertiefung) */
    .top .brand-pill{
      --pill-h: 36px;
      height: var(--pill-h);
      display: inline-flex;
      align-items: stretch;
      border-radius: 999px;
      overflow: hidden;
      padding: 0;
      background: #0b1220;
      border: none;
      outline: none;
      box-shadow:
        inset 10px 10px 18px rgba(0,0,0,0.65),
        inset -8px -8px 16px rgba(255,255,255,0.05);
    }
    .top .brand-pill::before{ content:none; }
    .top .brand-pill img{
      height: 100%;
      width: auto;
      display: block;
      border-radius: inherit;
      z-index: 1;
      opacity: 1;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif}
    .top{height:56px;display:flex;gap:8px;align-items:center;padding:0 12px;background:var(--panel);border-bottom:1px solid var(--border);position:relative;z-index:10}
    .brand{font-weight:800;letter-spacing:.02em}
    .ver{opacity:.75;margin-left:6px}
    .muted{color:var(--muted)}
    .sp{flex:1}
    .btn{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn:hover{border-color:var(--accent)}
    .btn:disabled,.toolbtn:disabled{opacity:.5;cursor:not-allowed}

    /* Viewport-Fix */
    .wrap{
      height:calc(100vh - 56px);
      display:grid;
      grid-template-columns:minmax(220px,280px) minmax(320px,1fr) minmax(280px,420px);
      gap:10px;padding:10px;overflow:hidden
    }
    @media (max-width:1000px){.wrap{grid-template-columns:minmax(200px,260px) minmax(320px,1fr)} .wrap>.panel:nth-child(3){grid-column:1/-1}}
    @media (max-width:680px){.wrap{grid-template-columns:1fr}}

    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel h3{margin:0;padding:10px 12px;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .content{padding:10px;overflow:auto}

    #sceneList{overflow:auto}
    .row{display:grid;grid-template-columns:24px 24px 1fr auto;gap:6px;align-items:center;padding:6px 8px;border-radius:8px}
    .row:hover{background:#0f1626}
    .icon{width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:1px solid var(--border);border-radius:8px;background:#0f1626}
    .tab{display:block;text-align:left;background:transparent;border:1px solid transparent;padding:6px 8px;border-radius:8px;cursor:pointer;color:var(--text);font-weight:700;min-width:0}
    .tab.active{border-color:var(--accent);box-shadow:inset 0 0 0 2px var(--accent)}
    .del{background:#0f1626;border:1px solid var(--border);color:var(--text);padding:6px 8px;border-radius:8px;cursor:pointer}

    .viewport{position:relative;overflow:hidden;min-height:0;height:100%}
    #stage{position:absolute;inset:0;width:100%;height:100%}
    canvas{display:block}

    .hint-fab{position:absolute;left:12px;bottom:12px;z-index:6;width:40px;height:40px;border-radius:999px;background:#0b1220cc;border:1px solid var(--border);color:var(--muted);display:flex;align-items:center;justify-content:center;font-weight:900;cursor:pointer}
    .hint{position:absolute;left:60px;right:12px;bottom:12px;background:#0b1220cc;border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px;color:var(--muted);z-index:5;transition:opacity .22s ease, transform .28s cubic-bezier(.2,.7,.2,1);transform-origin:left bottom}
    .hint.hidden{opacity:0;transform:translateY(8px) scaleX(.85);pointer-events:none}
    .status-badge{position:absolute;top:12px;right:12px;z-index:7;background:#0b1220cc;border:1px solid var(--border);border-radius:10px;padding:6px 10px;font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;pointer-events:none}
    .status-pill{padding:2px 8px;border:1px solid var(--border);border-radius:999px}

    .toast{position:fixed;bottom:14px;right:14px;background:#0b1220;border:1px solid var(--border);padding:10px 12px;border-radius:10px;display:none;z-index:1200}

    .menu{position:relative}
    .menubtn{background:var(--panel2);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:6px}
    .menu-pop{position:absolute;top:44px;left:0;min-width:220px;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:6px;display:none;z-index:2000;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    .menu.open .menu-pop{display:block}
    .menuitem{display:flex;align-items:center;gap:8px;width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid transparent;color:var(--text);cursor:pointer;text-align:left;font-weight:700}
    .menuitem:hover{background:var(--panel2);border-color:var(--border)}
    .menuitem input[type="file"]{display:none}

    .toolbar{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
    .toolbtn{background:#0f1626;border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:999px;cursor:pointer;font-weight:700}
    .toolbtn.active{outline:2px solid var(--accent)}

    .select,.input{background:#0f1420;border:1px solid var(--border);color:var(--text);padding:8px;border-radius:10px}
    .select option{background:#0f1420;color:var(--text)}
    .kv{display:grid;grid-template-columns:150px 1fr;gap:8px;align-items:center;margin-bottom:8px}

    /* Icons (Masken) – zentral definiert */
    :root{
      --ico-transform:     url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/transform_icon.svg");
      --ico-scene:         url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/camera%20icon.svg");
      --ico-animation:     url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/animation_movie_icon.svg");
      --ico-material:      url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/material-icon.svg");
      --ico-media:         url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/player_video_icon.svg");
      --ico-audio:         url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/audio_icon.svg");

      --ico-lock-closed:   url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/closed_lock_icon.svg");
      --ico-lock-open:     url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/lock_open_icon.svg");

      --ico-eye-open:      url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/eye_icon.svg");
      --ico-eye-closed:    url("https://raw.githubusercontent.com/KrischiHH/area/refs/heads/main/icons/eye_close_icon.svg");

      --ico-chev:          url("data:image/svg+xml,%3Csvg viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M8 10l4 4 4-4' fill='none' stroke='%23A9C7FF' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    }
    .ico-mask{
      width:16px; height:16px; flex:0 0 16px;
      background-color: currentColor;
      -webkit-mask: var(--ico) no-repeat center / contain;
              mask: var(--ico) no-repeat center / contain;
    }
    .ico--transform  { --ico: var(--ico-transform); }
    .ico--scene      { --ico: var(--ico-scene); }
    .ico--animation  { --ico: var(--ico-animation); }
    .ico--material   { --ico: var(--ico-material); }
    .ico--media      { --ico: var(--ico-media); }
    .ico--audio      { --ico: var(--ico-audio); }
    .ico--lock-closed{ --ico: var(--ico-lock-closed); }
    .ico--lock-open  { --ico: var(--ico-lock-open); }
    .ico--eye-open   { --ico: var(--ico-eye-open); }
    .ico--eye-closed { --ico: var(--ico-eye-closed); }
    .ico--chev       { --ico: var(--ico-chev); width:12px; height:12px; }
    .section > summary .sum-icons .ico-mask{ color: var(--muted); }

    .section{margin-bottom:10px;border:0}
    .section > summary{list-style:none;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:800;letter-spacing:.02em;color:var(--muted);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.08));border:1px solid var(--border);border-radius:999px;padding:8px 12px;transition:border-color .18s ease,background .18s ease}
    .section > summary::-webkit-details-marker,.section > summary::marker{display:none}
    .sum-icons{display:flex;align-items:center;gap:10px}
    .section > summary .ico--chev{display:inline-block;transform:rotate(-90deg);transform-origin:50% 50%;will-change:transform;transition:transform .18s ease}
    .section[open] > summary .ico--chev{transform:rotate(0deg)}
    .section[open] > summary{border-color:var(--accent);box-shadow:inset 0 0 0 1px var(--accent)}
    .section > summary:hover{border-color:var(--accent2)}
    .section .body{padding-top:10px}
    .section .body .kv{margin-bottom:8px}

    .viewport,#stage{min-width:0}
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div class="top">
    <a class="brand-pill" href="#" aria-label="Home" title="AREA">
      <img src="https://cdn.jsdelivr.net/gh/KrischiHH/area@58a250a0bc3b9868cf5e8d7ba12864720315662c/icons/areaLogo.jpg" alt="AREA Logo">
    </a>

    <div class="menu" id="projectMenu">
      <button id="btn-project-menu" class="menubtn" aria-haspopup="true" aria-expanded="false">Projekt ▾</button>
      <div class="menu-pop" id="projectMenuPop" role="menu">
        <button id="btn-new" class="menuitem" role="menuitem">+ Neues Projekt…</button>
        <label class="menuitem" role="menuitem">Projekt öffnen <input id="file-project" type="file" accept=".webar,.json"></label>
        <button id="btn-save" class="menuitem" role="menuitem">Speichern</button>
        <button id="btn-save-as" class="menuitem" role="menuitem">Speichern unter…</button>
        <button id="btn-publish" class="menuitem" role="menuitem">Veröffentlichen / Vorschau…</button>
      </div>
    </div>

    <label class="btn">Objekt import<input id="file-glb" type="file" accept=".glb,.gltf" style="display:none"></label>

    <label class="btn">Medien import
      <input id="file-media" type="file" accept="video/*,audio/*" style="display:none">
    </label>

    <div class="sp"></div>
    <div class="status-pill" id="projNamePill" title="Projektname (Doppelklick zum Umbenennen)">Unbenanntes Projekt</div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div class="panel">
      <h3>Szenenbaum</h3>
      <div id="sceneList" class="content"><div class="muted">Noch keine Objekte</div></div>
    </div>

    <!-- CENTER -->
    <div class="viewport">
      <div id="stage"></div>
      <div id="vpStatus" class="status-badge"><span id="vp-pill-space" class="status-pill">Space: Local</span><span id="vp-pill-snap" class="status-pill">Snap: Aus</span></div>
      <button id="hintFab" class="hint-fab" aria-expanded="false" title="Hinweise">i</button>
      <div class="hint hidden">LMB drehen · Rad zoomen · RMB/Shift+LMB schwenken · Klick = Auswahl (Shift=Mehrfach) · W/E/R Move/Rotate/Scale · D Duplizieren · F Drop-to-Floor · Entf Löschen · 1–5 Bookmarks · Shift+1–5 Speichern · Ctrl+G Gruppieren · Ctrl+Shift+G Aufheben</div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <h3>Eigenschaften</h3>
      <div class="content">
        <div class="toolbar">
          <button id="tool-move" class="toolbtn">Verschieben (W)</button>
          <button id="tool-rotate" class="toolbtn">Drehen (E)</button>
          <button id="tool-scale" class="toolbtn">Skalieren (R)</button>
        </div>

        <div class="toolbar">
          <button id="btn-duplicate" class="toolbtn" title="D">Duplizieren</button>
          <button id="btn-floor" class="toolbtn" title="F">Drop to Floor</button>
          <span class="toolbtn" style="pointer-events:none">Space:</span>
          <button id="space-local" class="toolbtn active">Lokal</button>
          <button id="space-world" class="toolbtn">Welt</button>
        </div>

        <div class="toolbar">
          <button id="btn-group" class="toolbtn" title="Ctrl+G" disabled>Gruppieren</button>
          <button id="btn-ungroup" class="toolbtn" title="Ctrl+Shift+G" disabled>Gruppierung aufheben</button>
        </div>

        <details id="sec-transform" class="section">
          <summary>
            <span class="sum-title">Transform</span>
            <span class="sum-icons">
              <span class="ico-mask ico--transform" aria-hidden="true"></span>
              <span class="ico-mask ico--chev" aria-hidden="true"></span>
            </span>
          </summary>

          <div class="body">
            <div class="kv"><div>Name</div><input id="prop-name" class="input" placeholder="Objekt"></div>
            <div class="kv"><div>Pos X</div><input id="posx" class="input" type="number" step="0.01"></div>
            <div class="kv"><div>Pos Y</div><input id="posy" class="input" type="number" step="0.01"></div>
            <div class="kv"><div>Pos Z</div><input id="posz" class="input" type="number" step="0.01"></div>
            <div class="kv"><div>Rot X°</div><input id="rotx" class="input" type="number" step="1"></div>
            <div class="kv"><div>Rot Y°</div><input id="roty" class="input" type="number" step="1"></div>
            <div class="kv"><div>Rot Z°</div><input id="rotz" class="input" type="number" step="1"></div>
            <div class="kv"><div>Scale</div><input id="scale" class="input" type="number" step="0.01"></div>

            <div class="kv"><div>Snap aktiv</div><label class="input" style="display:flex;align-items:center;gap:8px;background:transparent;border:none;padding:0"><input id="snapChk" type="checkbox"> <span class="muted">(öffnet Optionen)</span></label></div>
            <div id="snapPanel" style="display:none">
              <div class="kv"><div>Translate Snap (m)</div>
                <select id="transSnapSel" class="select">
                  <option value="">Off</option><option value="0.1" selected>0.1</option><option value="0.25">0.25</option><option value="0.5">0.5</option><option value="1">1.0</option>
                </select>
              </div>
              <div class="kv"><div>Rotate Snap (°)</div>
                <select id="rotSnapSel" class="select">
                  <option value="">Off</option><option value="15" selected>15°</option><option value="30">30°</option><option value="45">45°</option><option value="90">90°</option>
                </select>
              </div>
              <div class="kv"><div>Scale Snap</div>
                <select id="scaleSnapSel" class="select">
                  <option value="">Off</option><option value="0.1" selected>0.1</option><option value="0.25">0.25</option><option value="0.5">0.5</option>
                </select>
              </div>
            </div>
            <button id="btn-apply" class="btn" style="margin-top:6px">Übernehmen</button>
          </div>
        </details>

        <details id="sec-scene" class="section">
          <summary>
            <span class="sum-title">Szene &amp; Ansichten</span>
            <span class="sum-icons">
              <span class="ico-mask ico--scene" aria-hidden="true"></span>
              <span class="ico-mask ico--chev"  aria-hidden="true"></span>
            </span>
          </summary>
          <div class="body">
            <div class="toolbar">
              <button class="btn" id="btn-view-iso">Iso</button>
              <button class="btn" id="btn-view-front">Front</button>
              <button class="btn" id="btn-view-side">Seite</button>
              <button class="btn" id="btn-view-top">Top</button>
              <button class="btn" id="btn-frame-all">Fokus Szene</button>
              <button class="btn" id="btn-clear">Szene leeren</button>
            </div>
            <div class="kv"><div>Raumgröße</div><input id="roomSize" class="input" type="number" step="1" value="24"></div>
            <div class="kv"><div>Grid Helligkeit</div><input id="gridIntensity" class="input" type="range" min="0.5" max="1" step="0.05" value="0.95"></div>
            <div class="kv"><div>Grid anzeigen</div><label class="input" style="display:flex;align-items:center;gap:8px;background:transparent;border:none;padding:0"><input id="gridVisible" type="checkbox" checked> <span>Ein</span></label></div>
            <div class="kv"><div>Belichtung</div><input id="exposure" class="input" type="range" min="0.5" max="2" step="0.05" value="1"></div>

            <!-- ===== Anchor-Modus UI ===== -->
            <div class="kv"><div>Anchor-Modus</div>
              <select id="anchorMode" class="select">
                <option value="surface-webxr" selected>Surface (WebXR)</option>
                <option value="image">Image Trigger</option>
                <option value="native">Surface (Native)</option>
              </select>
            </div>

            <div id="imageTargetRow" class="kv" style="display:none">
              <div>Image Target (.mind)</div>
              <input id="imageTargetUrl" class="input" placeholder="https://…/target.mind" value="../assets/targets/target.mind">
            </div>

            <div id="nativeRow" class="kv" style="display:none">
              <div>Native Assets</div>
              <div style="display:grid;grid-template-columns:1fr;gap:6px">
                <input id="nativeGlbUrl"  class="input" placeholder="Android GLB – https://…/model.glb">
                <input id="nativeUsdzUrl" class="input" placeholder="iOS USDZ – https://…/model.usdz">
              </div>
            </div>
            <!-- ===== Ende Anchor-Modus UI ===== -->

          </div>
        </details>

        <details id="sec-look" class="section">
          <summary>
            <span class="sum-title">Material Look</span>
            <span class="sum-icons">
              <span class="ico-mask ico--material" aria-hidden="true"></span>
              <span class="ico-mask ico--chev"  aria-hidden="true"></span>
            </span>
          </summary>
          <div class="body">
            <div class="kv"><div>Mattheit (+Roughness)</div><input id="matRoughAdd" class="input" type="range" min="0" max="0.6" step="0.01" value="0.25"></div>
            <div class="kv"><div>Reflexionsstärke (IBL)</div><input id="matEnvMul" class="input" type="range" min="0" max="1.2" step="0.05" value="0.85"></div>
          </div>
        </details>

        <details id="sec-anim" class="section">
          <summary>
            <span class="sum-title">Animation</span>
            <span class="sum-icons">
              <span class="ico-mask ico--animation" aria-hidden="true"></span>
              <span class="ico-mask ico--chev"  aria-hidden="true"></span>
            </span>
          </summary>
          <div class="body">
            <div class="kv"><div>Clip</div><select id="animClip" class="select"></select></div>
            <div class="kv"><div>Loop</div>
              <select id="animLoop" class="select">
                <option value="off">aus</option>
                <option value="once">einmal</option>
                <option value="repeat" selected>wiederholen</option>
              </select>
            </div>
            <div class="kv"><div>Repeats</div><input id="animRepeats" class="input" type="number" step="1" min="1" value="9999"></div>
            <div class="toolbar">
              <button id="animPlay" class="toolbtn">Play</button>
              <button id="animStop" class="toolbtn">Stop</button>
              <button id="animPause" class="toolbtn">Pause</button>
            </div>
          </div>
        </details>

        <details id="sec-media" class="section" open style="display:none">
          <summary>
            <span class="sum-title">Medien</span>
            <span class="sum-icons">
              <span class="ico-mask ico--media" aria-hidden="true"></span>
              <span class="ico-mask ico--chev"  aria-hidden="true"></span>
            </span>
          </summary>
          <div class="body">
            <div class="kv"><div>Typ</div><input id="mediaType" class="input" disabled></div>
            <div class="kv"><div>Loop</div><label class="input" style="display:flex;align-items:center;gap:8px;background:transparent;border:none;padding:0"><input id="mediaLoop" type="checkbox"> <span>an</span></label></div>
            <div class="kv"><div>Wiederholungen</div><input id="mediaRepeats" class="input" type="number" min="1" step="1" value="1"></div>
            <div class="toolbar">
              <button id="mediaPlay"  class="toolbtn">Play</button>
              <button id="mediaPause" class="toolbtn">Pause</button>
              <button id="mediaStop"  class="toolbtn">Stop</button>
            </div>
          </div>
        </details>

        <div class="toolbar">
          <button id="btn-del" class="btn">Löschen (Entf)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { TransformControls } from 'three/addons/controls/TransformControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
    import * as SkeletonUtils from 'three/addons/utils/SkeletonUtils.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass }     from 'three/addons/postprocessing/RenderPass.js';
    import { OutlinePass }    from 'three/addons/postprocessing/OutlinePass.js';
    import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

    const $ = s=>document.querySelector(s);
    const toastEl = $('#toast');
    function toast(m){ toastEl.textContent=m; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none',1800); }

    // --- State ---
    let projectName = 'Unbenanntes Projekt';
    function setProjectName(n){ projectName = (n||'').trim()||'Unbenanntes Projekt'; $('#projNamePill').textContent = projectName; document.title = 'WebAR Editor v2.2.4 — '+projectName; }
    function promptNewName(){ const v = prompt('Projektname:', projectName==='Unbenanntes Projekt'?'Mein AR-Projekt':projectName); if(v!=null) setProjectName(v); }
    $('#projNamePill').addEventListener('dblclick', promptNewName);

    const stage = $('#stage');
    const renderer = new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});
    renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 2));
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    renderer.autoClear = false;
    stage.appendChild(renderer.domElement);

    const scene = new THREE.Scene(); scene.background = new THREE.Color('#0b1323');
    const overlayScene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(30,1,0.01,2000); camera.position.set(15,6,15);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true; controls.enablePan = true; controls.minDistance=0.2; controls.maxDistance=400;
    controls.target.set(0,0,0); controls.update();

    // Licht
    const hemi = new THREE.HemisphereLight(0xffffff, 0x334466, 1.2); scene.add(hemi);
    const dir  = new THREE.DirectionalLight(0xffffff, 2.5); dir.position.set(2,6,2); scene.add(dir);
    const amb = new THREE.AmbientLight(0xffffff, 0.25); scene.add(amb);

    // Environment (IBL)
    const pmrem = new THREE.PMREMGenerator(renderer);
    scene.environment = pmrem.fromScene(new RoomEnvironment(), 0.04).texture;

    // ==== MEDIA: AudioListener (für PositionalAudio)
    const audioListener = new THREE.AudioListener();
    camera.add(audioListener);

    // Transform Controls
    const tcontrols = new TransformControls(camera, renderer.domElement);
    tcontrols.addEventListener('dragging-changed', e=>{ controls.enabled = !e.value; });
    tcontrols.setMode('translate'); tcontrols.setSize(1.0);
    overlayScene.add(tcontrols);
    tcontrols.traverse(o=>{
      if (o.material){
        const mats = Array.isArray(o.material) ? o.material : [o.material];
        mats.forEach(m=>{ m.depthTest=false; m.depthWrite=false; m.toneMapped=false; m.transparent=true; });
      }
      o.renderOrder = 9999;
    });

    // Postprocessing (Outline)
    let composer, renderPass, outlinePass;
    function initPost(){
      composer = new EffectComposer(renderer);
      renderPass = new RenderPass(scene, camera);
      composer.addPass(renderPass);
      outlinePass = new OutlinePass(new THREE.Vector2(stage.clientWidth||1, stage.clientHeight||1), scene, camera);
      outlinePass.edgeStrength=3; outlinePass.edgeThickness=2; outlinePass.pulsePeriod=0;
      outlinePass.visibleEdgeColor.set('#9ecbff'); outlinePass.hiddenEdgeColor.set('#2a65b3');
      outlinePass.renderToScreen = true;
      composer.addPass(outlinePass);
    }
    initPost();

    let gridNear=null, gridFar=null, axisX=null, axisZ=null;

    function buildRoom(size = 24){
      [gridNear,gridFar,axisX,axisZ].forEach(o=>{ if(!o)return; scene.remove(o); o.geometry?.dispose?.(); o.material?.dispose?.(); });
      gridNear=gridFar=axisX=axisZ=null;

      const L=Math.max(2,size), div=Math.max(10,Math.round(L));
      const gi=parseFloat($('#gridIntensity').value)||0.95;
      const cNearLine=new THREE.Color(0x44577a).lerp(new THREE.Color(0x7f96c7),gi);
      const cNearCenter=new THREE.Color(0x506a92).lerp(new THREE.Color(0xaec1ea),gi);
      const cFar=new THREE.Color(0x1f2a44).lerp(new THREE.Color(0x2b3e64),gi);
      const opNear=0.22+0.48*gi, opFar=0.06+0.20*gi;

      gridNear=new THREE.GridHelper(L,div,cNearCenter,cNearLine);
      Object.assign(gridNear.material,{transparent:true,opacity:opNear,depthTest:true,depthWrite:false,toneMapped:false});
      gridNear.position.y=0.0025; scene.add(gridNear);

      gridFar=new THREE.GridHelper(2000,2000,cFar,cFar);
      Object.assign(gridFar.material,{transparent:true,opacity:opFar,depthTest:true,depthWrite:false,toneMapped:false});
      gridFar.position.y=-0.008; scene.add(gridFar);

      const half=L*0.5, y=0.0035, axisMat=new THREE.LineBasicMaterial({color:0xe7eefc,transparent:true,opacity:0.85*gi,depthTest:true,depthWrite:false,toneMapped:false});
      axisX=new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(-half,y,0),new THREE.Vector3(half,y,0)]),axisMat.clone());
      axisZ=new THREE.Line(new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,y,-half),new THREE.Vector3(0,y,half)]),axisMat.clone());
      scene.add(axisX,axisZ);

      const vis=$('#gridVisible').checked; [gridNear,gridFar,axisX,axisZ].forEach(o=>o&&(o.visible=vis));
    }

    function onResize(){
      const r = stage.getBoundingClientRect();
      const w = Math.max(1, r.width), h = Math.max(1, r.height);
      renderer.setSize(w, h, false);
      camera.aspect = w/h; camera.updateProjectionMatrix();
      composer?.setSize(w,h);
      const pr=renderer.getPixelRatio(); outlinePass?.resolution.set(w*pr,h*pr);
    }
    new ResizeObserver(onResize).observe(stage); onResize();

    // Selection & data model
    const raycaster = new THREE.Raycaster(); const mouse = new THREE.Vector2();
    const state = { objects: [], selectedId:null, selection:new Set() };
    function uid(){ return 'o_'+Math.random().toString(36).slice(2,9); }

    const gltfLoader = new GLTFLoader();
    const draco = new DRACOLoader(); draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/'); gltfLoader.setDRACOLoader(draco);

    function forEachRec(fn){ function visit(rec){ fn(rec); if(rec.type==='group' && rec.children) rec.children.forEach(visit); } state.objects.forEach(visit); }

    function rebuildList(){
      const root = $('#sceneList'); root.innerHTML = '';
      if (!state.objects.length){ root.innerHTML = '<div class="muted">Noch keine Objekte</div>'; return; }

      state.objects.forEach(o=>{
        const row = document.createElement('div'); row.className='row';
        const eye = document.createElement('div'); eye.className='icon eye'; eye.textContent = o.hidden ? '🚫' : '👁️'; eye.title = o.hidden ? 'Einblenden' : 'Ausblenden';
        const lock = document.createElement('div'); lock.className='icon lock';
        lock.innerHTML = `<span class="ico-mask ${o.locked ? 'ico--lock-closed' : 'ico--lock-open'}"></span>`; lock.title = o.locked ? 'Entsperren' : 'Sperren';
        const tab = document.createElement('button'); tab.type='button'; tab.className='tab'+(state.selection.has(o.id)?' active':''); tab.innerHTML='<span class="name"></span>';
        const prefix = o.media ? (o.media.kind==='video'?'🎞️ ':'🔊 ') : (o.type==='group'?'📦 ':'');
        tab.querySelector('.name').textContent = prefix + o.name;

        const del = document.createElement('button'); del.type='button'; del.className='del'; del.textContent='✕';

        row.append(eye,lock,tab,del); root.appendChild(row);

        eye.addEventListener('click', ()=>{ o.hidden=!o.hidden; if(o.group) o.group.visible=!o.hidden; eye.textContent=o.hidden?'🚫':'👁️'; eye.title=o.hidden?'Einblenden':'Ausblenden'; updateOutlineSelection(); });
        lock.addEventListener('click', ()=>{ o.locked=!o.locked; lock.innerHTML=`<span class="ico-mask ${o.locked?'ico--lock-closed':'ico--lock-open'}"></span>`; lock.title=o.locked?'Entsperren':'Sperren';
          if (o.locked && state.selection.has(o.id)){ state.selection.delete(o.id); if(state.selectedId===o.id) state.selectedId=null; tcontrols.detach(); syncPropFromSel(); updateGroupButtons(); updateOutlineSelection(); }
        });
        tab.addEventListener('click', (ev)=>{ if(o.locked){ toast('Objekt ist gesperrt'); return; } if(ev.shiftKey) toggleSelect(o.id); else selectOnly(o.id); });
        del.addEventListener('click', ()=> deleteIds([o.id]));
      });
    }

    function findRec(id){ return state.objects.find(o=>o.id===id); }

    function selectOnly(id){
      state.selection.clear(); state.selection.add(id); state.selectedId=id;
      tcontrols.attach(findRec(id)?.group||null);
      syncPropFromSel(); rebuildList(); updateGroupButtons(); updateOutlineSelection(); syncMediaUI();
    }
    function toggleSelect(id){
      if(state.selection.has(id)) state.selection.delete(id); else state.selection.add(id);
      state.selectedId = Array.from(state.selection).slice(-1)[0]||null;
      if(state.selection.size===1){ tcontrols.attach(findRec(state.selectedId)?.group||null);} else { tcontrols.detach(); }
      syncPropFromSel(); rebuildList(); updateGroupButtons(); updateOutlineSelection(); syncMediaUI();
    }
    function clearSelection(){
      state.selection.clear(); state.selectedId=null; tcontrols.detach();
      syncPropFromSel(); rebuildList(); updateGroupButtons(); updateOutlineSelection(); syncMediaUI();
    }

    function updateOutlineSelection(){
      if(!outlinePass) return;
      const selMeshes = [];
      [...state.selection].forEach(id=>{
        const rec = findRec(id);
        if(rec && rec.group){
          rec.group.traverse(ch=>{
            if (ch.isMesh && !ch.userData?.__pickProxy) selMeshes.push(ch);
          });
        }
      });
      outlinePass.selectedObjects = selMeshes;
    }

    let down=null, isOrbiting=false;
    controls.addEventListener('start', ()=>{isOrbiting=true}); controls.addEventListener('end', ()=>{isOrbiting=false});
    renderer.domElement.addEventListener('pointerdown', e=>{ if(tcontrols?.dragging) return; down={x:e.clientX,y:e.clientY}; }, {passive:true});
    renderer.domElement.addEventListener('pointerup', e=>{
      if(!down) return; const moved=Math.hypot(e.clientX-down.x,e.clientY-down.y); down=null; if(tcontrols?.dragging||moved>3) return;
      const rect=renderer.domElement.getBoundingClientRect(); mouse.x=((e.clientX-rect.left)/rect.width)*2-1; mouse.y=-((e.clientY-rect.top)/rect.height)*2+1; raycaster.setFromCamera(mouse,camera);
      const targets = state.objects.filter(o=>!o.hidden && !o.locked).map(o=>o.group);
      const hits = raycaster.intersectObjects(targets,true);
      if(hits.length){
        let obj3=hits[0].object; while(obj3 && obj3.parent && obj3.parent!==scene) obj3=obj3.parent;
        const rec=state.objects.find(o=>o.group===obj3);
        if(rec){ if(e.shiftKey) toggleSelect(rec.id); else selectOnly(rec.id); }
      }
    }, {passive:true});
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') clearSelection(); });
    renderer.domElement.addEventListener('dblclick', e=>{
      if(isOrbiting||tcontrols?.dragging) return;
      const rect=renderer.domElement.getBoundingClientRect(); mouse.x=((e.clientX-rect.left)/rect.width)*2-1; mouse.y=-((e.clientY-rect.top)/rect.height)*2+1; raycaster.setFromCamera(mouse,camera);
      const targets=state.objects.filter(o=>!o.hidden && !o.locked).map(o=>o.group);
      const hits = raycaster.intersectObjects(targets,true);
      if(hits.length===0) clearSelection();
    }, {passive:true});

    // Import GLB
    async function createGroupedFromURL(url,name){
      const gltf = await gltfLoader.loadAsync(url);
      const root = gltf.scene || gltf.scenes?.[0];
      const group = new THREE.Group(); group.name = name || 'Objekt';
      group.add(root);
      const box=new THREE.Box3().setFromObject(group); const center=new THREE.Vector3(); box.getCenter(center);
      group.children.forEach(c=>c.position.sub(center)); group.position.add(center);
      const clips=(gltf.animations||[]).slice();
      return { group, root, clips };
    }
    function fitUniformScale(group, fit=1.5){ const b=new THREE.Box3().setFromObject(group); const s=new THREE.Vector3(); b.getSize(s); const maxDim=Math.max(s.x,s.y,s.z)||1; group.scale.setScalar(fit/maxDim); }

    function addPickProxy(rec){
      rec.group.traverse(c=>{ if(c.userData?.__pickProxy){ c.parent?.remove(c); c.geometry?.dispose?.(); c.material?.dispose?.(); }});
      rec.group.updateMatrixWorld(true);
      const boxW=new THREE.Box3().setFromObject(rec.group); if(!isFinite(boxW.min.x)) return;
      const cornersW=[new THREE.Vector3(boxW.min.x,boxW.min.y,boxW.min.z),new THREE.Vector3(boxW.min.x,boxW.min.y,boxW.max.z),new THREE.Vector3(boxW.min.x,boxW.max.y,boxW.min.z),new THREE.Vector3(boxW.min.x,boxW.max.y,boxW.max.z),new THREE.Vector3(boxW.max.x,boxW.min.y,boxW.min.z),new THREE.Vector3(boxW.max.x,boxW.min.y,boxW.max.z),new THREE.Vector3(boxW.max.x,boxW.max.y,boxW.min-z),new THREE.Vector3(boxW.max.x,boxW.max.y,boxW.max.z)];
      // ^ small typo fixed? (Keep original) -> We'll keep original coordinates:
    }
  </script>
</body>
</html>
