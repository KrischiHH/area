<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Surface Viewer – AR (scene.json)</title>
<style>
  *,*::before,*::after{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui;overflow:hidden}
  .a-enter-vr,.a-enter-ar,.a-enter-vr-button{display:none!important}
  a-scene, canvas.a-canvas{background:transparent!important}

  /* UI */
  #ui{position:fixed;inset:0;pointer-events:none;z-index:10}
  #hint{position:absolute;left:50%;bottom:max(20px,env(safe-area-inset-bottom));transform:translateX(-50%);
        background:rgba(0,0,0,.55);padding:10px 12px;border-radius:12px;font-size:14px;pointer-events:auto}
  #top{position:absolute;right:max(12px,env(safe-area-inset-right));top:max(12px,env(safe-area-inset-top));display:flex;gap:8px}
  .btn{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
  #err{position:fixed;left:12px;top:12px;background:#b00020;padding:8px 10px;border-radius:8px;font:12px/1.35 monospace;display:none;z-index:99}
</style>

<!-- A-Frame (WebXR) + Extras (Animation Mixer) -->
<script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
<script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
</head>
<body>
<div id="err"></div>

<!-- UI -->
<div id="ui">
  <div id="top">
    <button id="reset" class="btn">Neu platzieren</button>
  </div>
  <div id="hint">Bewege das Gerät, bis der Ring stabil ist. Tippe, um das Objekt zu platzieren.</div>
</div>

<!-- AR Szene -->
<a-scene
  renderer="alpha:true; antialias:false; precision:mediump; physicallyCorrectLights:false; colorManagement:true"
  webxr="optionalFeatures: hit-test, dom-overlay; overlayElement: #ui"
  vr-mode-ui="enabled:false"
  embedded>
  <a-entity light="type:hemisphere; intensity:1.0"></a-entity>
  <a-entity id="dirLight" light="type:directional; intensity:0.9" position="0 6 0"></a-entity>

  <!-- Reticle -->
  <a-entity id="reticle" visible="false"
            geometry="primitive:ring; radiusInner:0.04; radiusOuter:0.05; segmentsTheta:64"
            material="color:#00ffff; shader:flat" rotation="-90 0 0">
  </a-entity>

  <!-- Container für dein Modell -->
  <a-entity id="anchor" visible="false"></a-entity>

  <a-camera position="0 1.6 0" wasd-controls-enabled="false" look-controls="enabled:true"></a-camera>
</a-scene>

<script>
/* ----------- Szene laden: ?scene=URL ----------- */
const qs = new URLSearchParams(location.search);
const sceneUrl = qs.get('scene');
const showErr = m => { const el = document.getElementById('err'); el.textContent = m; el.style.display='block'; };

let cfg = {
  model:  { url:"https://modelviewer.dev/shared-assets/models/Astronaut.glb",
            position:[0,0,0], rotation:[0,0,0], scale:[0.6,0.6,0.6], animation:"*" },
  lighting: { hemi:1.0, dir:{ intensity:0.9, pos:[0,6,0] } }
};
(async ()=>{
  if (sceneUrl){
    try{
      const r = await fetch(sceneUrl, {cache:'no-cache'}); if(!r.ok) throw new Error(r.status+' '+r.statusText);
      const j = await r.json();
      // nur relevante Felder für Surface übernehmen
      cfg.model    = Object.assign(cfg.model, j.model||{});
      cfg.lighting = Object.assign(cfg.lighting, j.lighting||{});
      if (j.lighting?.dir) cfg.lighting.dir = Object.assign(cfg.lighting.dir, j.lighting.dir);
    }catch(e){ showErr('scene.json konnte nicht geladen werden: '+e.message); }
  }
  // Lichter anwenden
  document.getElementById('dirLight').setAttribute('light', `type:directional; intensity:${cfg.lighting.dir.intensity??0.9}`);
  document.getElementById('dirLight').setAttribute('position', (cfg.lighting.dir.pos??[0,6,0]).join(' '));
})();

/* ----------- Hit-Test / Platzieren ----------- */
AFRAME.registerComponent('ar-hit-placement', {
  init(){
    this.viewerSpace = null; this.hitTestSource = null; this.xrSession = null;
    this.reticle = document.getElementById('reticle');
    this.anchor  = document.getElementById('anchor');
    this.placed  = false;

    this.el.sceneEl.renderer.xr.addEventListener('sessionstart', async (ev)=>{
      this.xrSession = this.el.sceneEl.renderer.xr.getSession();
      const refSpace = await this.xrSession.requestReferenceSpace('local');
      this.viewerSpace = await this.xrSession.requestReferenceSpace('viewer');
      const src = await this.xrSession.requestHitTestSource({ space: this.viewerSpace });
      this.hitTestSource = src;

      // Tap zum Platzieren
      this.onSelect = (e)=>{
        if (!this.reticle.object3D.visible) return;
        if (!this.model){
          // Modell erstellen, falls noch nicht angelegt
          this.model = document.createElement('a-gltf-model');
          this.model.setAttribute('src', cfg.model.url);
          this.model.setAttribute('position', '0 0 0');
          if (cfg.model.rotation) this.model.setAttribute('rotation', cfg.model.rotation.join(' '));
          if (cfg.model.scale)    this.model.setAttribute('scale',    cfg.model.scale.join(' '));
          if (cfg.model.animation && cfg.model.animation !== 'none'){
            this.model.setAttribute('animation-mixer', `clip:${cfg.model.animation}; loop:repeat`);
          }
          this.anchor.appendChild(this.model);
        }
        // Anchor auf Reticle setzen
        this.anchor.object3D.position.copy(this.reticle.object3D.position);
        this.anchor.object3D.quaternion.copy(this.reticle.object3D.quaternion);
        this.anchor.setAttribute('visible', 'true');
        this.placed = true;
        document.getElementById('hint').textContent = 'Platziert. Tippe „Neu platzieren“, um zu verschieben.';
      };
      this.xrSession.addEventListener('select', this.onSelect);

      // Reset-Button
      document.getElementById('reset').addEventListener('click', ()=>{
        this.placed = false;
        this.anchor.setAttribute('visible','false');
        document.getElementById('hint').textContent = 'Bewege das Gerät, bis der Ring stabil ist. Tippe, um zu platzieren.';
      });
    });

    this.el.sceneEl.renderer.xr.addEventListener('sessionend', ()=>{
      this.hitTestSource = null; this.viewerSpace = null; this.xrSession = null;
      this.reticle.setAttribute('visible','false'); this.placed=false;
    });
  },
  tick(time, delta){
    const xr = this.el.sceneEl.renderer.xr;
    const session = xr.getSession && xr.getSession();
    if (!session || !this.hitTestSource) return;

    const frame = xr.getFrame();
    const refSpace = xr.getReferenceSpace();
    const hits = frame.getHitTestResults(this.hitTestSource);
    if (hits.length > 0){
      const pose = hits[0].getPose(refSpace);
      const m = new THREE.Matrix4().fromArray(pose.transform.matrix);
      const p = new THREE.Vector3(); const q = new THREE.Quaternion(); const s = new THREE.Vector3();
      m.decompose(p,q,s);
      this.reticle.object3D.position.copy(p);
      this.reticle.object3D.quaternion.copy(q);
      this.reticle.setAttribute('visible', this.placed ? false : true);
    } else {
      this.reticle.setAttribute('visible', 'false');
    }
  }
});
document.querySelector('a-scene').setAttribute('ar-hit-placement','');
</script>
</body>
</html>
