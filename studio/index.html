<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Studio – Editor + Viewport + Publish</title>
<style>
  :root{--bg:#0e1116;--panel:#0b1323;--muted:#94a3b8;--fg:#e9ecf5;--border:#24314a;--accent:#223049}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  header.top{display:flex;gap:12px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
  header.top b{font-weight:700}
  header.top .muted{color:var(--muted)}
  main.app{display:grid;grid-template-columns:280px 1fr;grid-template-rows:1fr;gap:0;height:calc(100% - 52px)}
  aside.sidebar{border-right:1px solid var(--border);padding:10px 10px 14px;overflow:auto}
  #viewport{position:relative;background:#000}
  #canvasWrap{position:absolute;inset:0}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],select{width:100%;background:#0e1628;border:1px solid #27334b;color:#e9ecf5;border-radius:8px;padding:8px}
  input[type="file"]{width:100%}
  button{background:#223049;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:8px 10px;cursor:pointer}
  .muted{color:#a6b4cf}
  .small{font-size:12px;color:#a6b4cf}
  .hline{height:1px;background:var(--border);margin:10px 0}
  .toolbar{position:absolute;left:max(12px,env(safe-area-inset-left));top:max(12px,env(safe-area-inset-top));display:flex;gap:6px;z-index:5}
  .chip{background:#111a2a;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:6px 10px}
  #status{position:absolute;left:max(12px,env(safe-area-inset-left));bottom:max(10px,env(safe-area-inset-bottom));z-index:5;opacity:.9}
  #err{position:fixed;left:12px;top:12px;z-index:99;background:#b00020;padding:8px 10px;border-radius:8px;display:none;font:12px/1.35 monospace;max-width:min(92vw,680px);white-space:pre-wrap}
  /* Publish Panel floating */
  #pub-toggle{position:fixed;right:16px;bottom:16px;z-index:99998;background:#1f2a44;color:#fff;border:1px solid #2a3347;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  #pub-panel{position:fixed;right:16px;bottom:66px;z-index:99999;width:360px;max-width:92vw;background:#0b1323f2;color:#e9ecf5;border:1px solid #2a3347;border-radius:14px;box-shadow:0 20px 48px rgba(0,0,0,.35);display:none}
  #pub-panel header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
  #pub-panel .body{padding:10px 12px;display:grid;gap:10px}
  #pub-panel .row>*{flex:1}
  #pub-qr{display:block;margin:6px auto 0;background:#fff;border-radius:8px;max-width:100%}
</style>

<!-- three.js + addons -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<header class="top">
  <b>AR Studio – Editor</b><span class="muted">Viewport + Animation + Publish</span>
  <span style="flex:1"></span>
  <span class="muted small">Tipp: GLB aus Blender exportieren (bin+Texturen eingebettet).</span>
</header>

<main class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="field">
      <label class="small">GLB/GLTF Datei</label>
      <input id="f-file" type="file" accept=".glb,.gltf"/>
    </div>
    <div class="field">
      <label class="small">oder GLB/GLTF URL</label>
      <input id="f-url" type="text" placeholder="https://…/model.glb"/>
      <div class="row">
        <button id="btn-load">Laden</button>
        <button id="btn-probe">Animationen erkennen</button>
      </div>
    </div>

    <div class="hline"></div>

    <div class="field">
      <label class="small">Animation</label>
      <select id="anim-name">
        <option value="*">alle</option>
      </select>
      <div class="row">
        <button id="anim-play">Play</button>
        <button id="anim-pause">Pause</button>
        <label class="row" style="gap:6px"><span class="small">Speed</span><input id="anim-speed" type="number" step="0.1" value="1.0"/></label>
      </div>
      <label class="row" style="gap:8px;align-items:center"><input id="anim-loop" type="checkbox" checked/><span class="small">Loop</span></label>
    </div>

    <div class="hline"></div>

    <div class="field">
      <label class="small">Gizmo</label>
      <div class="row">
        <button data-gizmo="translate">Move</button>
        <button data-gizmo="rotate">Rotate</button>
        <button data-gizmo="scale">Scale</button>
      </div>
    </div>

    <div class="field">
      <label class="small">Transform</label>
      <div class="row"><label class="small" style="width:40px">Pos</label>
        <input id="p-x" type="number" step="0.01" value="0"><input id="p-y" type="number" step="0.01" value="0"><input id="p-z" type="number" step="0.01" value="0">
      </div>
      <div class="row"><label class="small" style="width:40px">Rot°</label>
        <input id="r-x" type="number" step="1" value="0"><input id="r-y" type="number" step="1" value="0"><input id="r-z" type="number" step="1" value="0">
      </div>
      <div class="row"><label class="small" style="width:40px">Scale</label>
        <input id="s-uniform" type="number" step="0.01" value="1">
      </div>
    </div>

    <div class="hline"></div>

    <div class="field">
      <label class="row" style="gap:8px;align-items:center"><input id="grid-toggle" type="checkbox" checked><span class="small">Grid anzeigen</span></label>
      <div class="row">
        <button id="cam-reset">Kamera reset</button>
      </div>
    </div>

    <div class="hline"></div>

    <div class="small muted">Publish sitzt unten rechts (schwebender Button). Der Link öffnet deinen <code>viewer.html</code> und übernimmt Modell, Transform & Animation.</div>
  </aside>

  <!-- VIEWPORT -->
  <section id="viewport" aria-label="3D Viewport">
    <div class="toolbar">
      <span class="chip" id="modelName">Kein Modell</span>
    </div>
    <div id="canvasWrap"></div>
    <div id="status" class="small muted">Bereit…</div>
  </section>
</main>

<!-- Publish Panel -->
<button id="pub-toggle" title="Publish (Surface/Image AR)">Publish</button>
<aside id="pub-panel" role="dialog" aria-modal="false" aria-label="Publish">
  <header>
    <b>Publish – WebAR Link</b>
    <div style="flex:1"></div>
    <button id="pub-close" title="Schließen" style="padding:6px 8px;border-radius:8px">✕</button>
  </header>
  <div class="body">
    <label>Viewer URL
      <input id="pub-viewer-url" type="text" value="../viewer.html" placeholder="./viewer.html">
    </label>

    <div style="border:1px solid var(--border);border-radius:12px;padding:10px">
      <h4 style="margin:0 0 8px 0;font-size:13px;color:#cbd5e1">Quelle wählen</h4>
      <div class="row" style="display:flex;gap:8px">
        <button id="pub-surface">Surface-AR Link</button>
        <button id="pub-image">Image-AR Link</button>
      </div>
      <div class="row" style="margin-top:8px">
        <input id="pub-image-file" type="file" accept="image/*">
        <label>Bildbreite (m)<input id="pub-image-width" type="number" step="0.01" min="0.05" value="0.20"></label>
      </div>
    </div>

    <label>Link
      <input id="pub-link" type="text" readonly placeholder="Hier erscheint der Link…">
    </label>
    <canvas id="pub-qr" width="0" height="0"></canvas>
    <div class="small">Scanne den QR-Code oder kopiere den Link. Für AR ist HTTPS erforderlich.</div>
  </div>
</aside>

<div id="err"></div>

<script type="module">
import * as THREE from 'three';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {TransformControls} from 'three/addons/controls/TransformControls.js';

const $ = s=>document.querySelector(s);
const status = (t)=> $("#status").textContent = t;
const showErr = (m)=>{ const el=$("#err"); el.textContent=m; el.style.display='block'; console.error(m); setTimeout(()=>el.style.display='none', 5000); };

// --- THREE Setup ---
let scene, camera, renderer, orbit, gizmo, grid;
let model=null, mixer=null, clips=[], modelSrc=null, modelName='';

init3D();
resize(); addEventListener('resize', resize);

function init3D(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x000000);
  camera = new THREE.PerspectiveCamera(50, 16/9, 0.01, 200);
  camera.position.set(1.8, 1.2, 2.4);

  renderer = new THREE.WebGLRenderer({antialias:true, alpha:false, powerPreference:'low-power'});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.setPixelRatio(Math.min(devicePixelRatio||1,1.8));
  $("#canvasWrap").appendChild(renderer.domElement);

  const amb = new THREE.HemisphereLight(0xffffff, 0x222244, 1.0); scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 1.2); dir.position.set(3,5,2); scene.add(dir);

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.enableDamping = true;

  gizmo = new TransformControls(camera, renderer.domElement);
  gizmo.addEventListener('dragging-changed', e=> orbit.enabled = !e.value);
  scene.add(gizmo);

  grid = new THREE.GridHelper(10, 20, 0x335577, 0x223344); grid.position.y = 0; scene.add(grid);

  animate();
}
function resize(){ const el=$("#viewport"); const w=el.clientWidth, h=el.clientHeight; renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix(); }

// --- Loading & Animation ---
const loader = new GLTFLoader();

async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }

async function loadFrom(src, niceName=''){
  status('Lade Modell…');
  modelSrc = src; modelName = niceName || (typeof src==='string' ? src.split('/').pop() : 'Datei');
  $("#modelName").textContent = modelName;

  // Dispose previous
  if (model){ gizmo.detach(); scene.remove(model); model.traverse(o=>{ if(o.geometry) o.geometry.dispose(); if(o.material){ const m=o.material; if(Array.isArray(m)) m.forEach(x=>x.dispose()); else m.dispose(); } }); }
  if (mixer){ mixer.uncacheRoot(model); mixer = null; }
  clips = []; setAnimUI([]);

  return new Promise((resolve,reject)=>{
    loader.load(src, gltf=>{
      model = gltf.scene || gltf.scenes[0];
      // normalize scale a bit (optional):
      model.position.set(0,0,0);
      model.rotation.set(0,0,0);
      model.scale.set(1,1,1);
      scene.add(model);
      gizmo.attach(model);

      clips = gltf.animations||[];
      if (clips.length){ mixer = new THREE.AnimationMixer(model); }
      setAnimUI(clips.map(c=>c.name||''));
      status(`${modelName} geladen. ${clips.length} Animation(en).`);
      resolve();
    }, undefined, err=>{ showErr('Laden fehlgeschlagen: '+err.message); reject(err); });
  });
}

function setAnimUI(names){
  const sel=$("#anim-name");
  const keep=sel.value;
  sel.innerHTML='<option value="*">alle</option>';
  names.forEach(n=> sel.insertAdjacentHTML('beforeend', `<option value="${n}">${n||'(unbenannt)'}</option>`));
  if ([...sel.options].some(o=>o.value===keep)) sel.value=keep;
}

function playSelection(){
  if (!mixer || !clips.length) return;
  mixer.stopAllAction();
  const speed=parseFloat($("#anim-speed").value||'1')||1; const loop=$("#anim-loop").checked;
  mixer.timeScale = speed;

  const pick=$("#anim-name").value;
  let acts=[];
  if (pick==='*'){ acts = clips.map(c=>mixer.clipAction(c)); }
  else {
    const c = clips.find(c=>c.name===pick) || clips[0];
    if (c) acts=[mixer.clipAction(c)];
  }
  acts.forEach(a=>{ a.clampWhenFinished=!loop; a.setLoop(loop?THREE.LoopRepeat:THREE.LoopOnce, Infinity).play(); });
}

function pauseAll(){ if (mixer){ mixer.timeScale = 0; } }

// --- UI bindings ---
$("#btn-load").onclick = async ()=>{
  const f=$("#f-file").files[0];
  const url=($("#f-url").value||'').trim();
  try{
    if (f){ const data=await fileToDataURL(f); await loadFrom(data, f.name); }
    else if (url){ await loadFrom(url); }
    else { alert('Datei auswählen oder URL eintragen.'); }
    syncTransformInputsFromModel();
  }catch(e){}
};
$("#btn-probe").onclick = async ()=>{
  if (!modelSrc){ // lädt nur um Clipnamen zu lesen
    const f=$("#f-file").files[0]; const url=($("#f-url").value||'').trim();
    if (!f && !url) return alert('Datei oder URL angeben.');
    try{
      const src = f ? await fileToDataURL(f) : url;
      await loadFrom(src, f?f.name:'');
      pauseAll();
    }catch(e){}
  } else {
    // nur UI refresh
    setAnimUI(clips.map(c=>c.name||'')); 
  }
};

$("#anim-play").onclick = playSelection;
$("#anim-pause").onclick = pauseAll;
$("#anim-name").onchange = ()=>{ if(mixer) playSelection(); };
$("#anim-speed").onchange = ()=>{ if(mixer) playSelection(); };
$("#anim-loop").onchange = ()=>{ if(mixer) playSelection(); };

document.querySelectorAll('[data-gizmo]').forEach(btn=>{
  btn.onclick = ()=> gizmo.setMode(btn.dataset.gizmo);
});

$("#grid-toggle").onchange = ()=> grid.visible = $("#grid-toggle").checked;
$("#cam-reset").onclick = ()=>{ camera.position.set(1.8,1.2,2.4); orbit.target.set(0,0,0); orbit.update(); };

function syncTransformInputsFromModel(){
  if (!model) return;
  $("#p-x").value = model.position.x.toFixed(2);
  $("#p-y").value = model.position.y.toFixed(2);
  $("#p-z").value = model.position.z.toFixed(2);
  $("#r-x").value = THREE.MathUtils.radToDeg(model.rotation.x).toFixed(0);
  $("#r-y").value = THREE.MathUtils.radToDeg(model.rotation.y).toFixed(0);
  $("#r-z").value = THREE.MathUtils.radToDeg(model.rotation.z).toFixed(0);
  $("#s-uniform").value = model.scale.x.toFixed(2);
}
["p-x","p-y","p-z","r-x","r-y","r-z","s-uniform"].forEach(id=>{
  $("#"+id).addEventListener('change', ()=>{
    if (!model) return;
    const px=parseFloat($("#p-x").value||'0'), py=parseFloat($("#p-y").value||'0'), pz=parseFloat($("#p-z").value||'0');
    const rx=THREE.MathUtils.degToRad(parseFloat($("#r-x").value||'0'));
    const ry=THREE.MathUtils.degToRad(parseFloat($("#r-y").value||'0'));
    const rz=THREE.MathUtils.degToRad(parseFloat($("#r-z").value||'0'));
    const s=parseFloat($("#s-uniform").value||'1');
    model.position.set(px,py,pz); model.rotation.set(rx,ry,rz); model.scale.set(s,s,s);
  });
});
gizmo.addEventListener('objectChange', syncTransformInputsFromModel);

// --- Publish (build payload from current editor state) ---
function encodeHash(obj){ const json=JSON.stringify(obj); return '#'+btoa(unescape(encodeURIComponent(json))); }

async function buildPayload(){
  if (!model || !modelSrc) throw new Error('Kein Modell im Viewport. Lade zuerst ein GLB/GLTF.');
  // Quelle: bei Datei haben wir DataURL bereits in modelSrc; URL bleibt URL.
  const s=model.scale.x;
  const pos=[model.position.x, model.position.y, model.position.z];
  const rot=[THREE.MathUtils.radToDeg(model.rotation.x), THREE.MathUtils.radToDeg(model.rotation.y), THREE.MathUtils.radToDeg(model.rotation.z)];
  const payload = {
    src: modelSrc, scale:s, position:pos, rotationDeg:rot,
    animSpeed: parseFloat($("#anim-speed").value||'1')||1,
    animLoop: $("#anim-loop").checked
  };
  const pick=$("#anim-name").value;
  if (pick==='*') payload.animation='*'; else payload.animName=pick;
  return payload;
}

async function makeSurfaceLink(){ const p=await buildPayload(); p.mode='surface'; return ($("#pub-viewer-url").value||'./viewer.html') + encodeHash(p); }
async function makeImageLink(){
  const p=await buildPayload(); p.mode='image';
  const f=$("#pub-image-file").files[0]; if(!f) throw new Error('Kein Trigger-Bild gewählt.');
  p.image = await fileToDataURL(f); p.imageWidthMeters = Number($("#pub-image-width").value||'0.2')||0.2;
  return ($("#pub-viewer-url").value||'./viewer.html') + encodeHash(p);
}

// QR helper
const QR_URL = "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
function ensureQR(){ return new Promise(res=>{ if (window.QRCode) return res(); const s=document.createElement('script'); s.src=QR_URL; s.onload=res; s.onerror=res; document.head.appendChild(s); }); }
async function drawQR(text){
  await ensureQR(); const cnv=$("#pub-qr"); if(!window.QRCode||!cnv){cnv.hidden=true;return;}
  const dataUrl = await window.QRCode.toDataURL(text,{errorCorrectionLevel:'L',width:280,margin:1});
  const img=new Image(); img.onload=()=>{cnv.width=img.width; cnv.height=img.height; const ctx=cnv.getContext('2d'); ctx.clearRect(0,0,cnv.width,cnv.height); ctx.drawImage(img,0,0);}; img.src=dataUrl;
}

// Publish panel UI
$("#pub-toggle").onclick = ()=> $("#pub-panel").style.display = ($("#pub-panel").style.display==='block'?'none':'block');
$("#pub-close").onclick = ()=> $("#pub-panel").style.display='none';
$("#pub-surface").onclick = async ()=>{ try{ const link=await makeSurfaceLink(); $("#pub-link").value=link; drawQR(link);}catch(e){ showErr(e.message);} };
$("#pub-image").onclick = async ()=>{ try{ const link=await makeImageLink(); $("#pub-link").value=link; drawQR(link);}catch(e){ showErr(e.message);} };

// --- Loop ---
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt=clock.getDelta();
  if (mixer && mixer.timeScale!==0) mixer.update(dt);
  orbit.update();
  renderer.render(scene,camera);
}
</script>
</body>
</html>
