<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>AR Studio – Projekte · Import · Gizmo · Publish</title>

<!-- THREE + Addons -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<!-- deps (klein & robust) -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{--bg:#0e1116;--panel:#0b1323;--muted:#94a3b8;--fg:#e9ecf5;--border:#24314a;--accent:#223049}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Arial}

  /* Topbar */
  .bar{display:flex;gap:8px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
  .bar .title{font-weight:600}
  .bar button,.bar select{padding:8px 10px;border-radius:10px;border:1px solid #2a3347;background:#1a233a;color:#fff}
  .bar .muted{color:var(--muted)}

  /* Layout */
  .layout{display:grid;grid-template-columns:minmax(340px,420px) 1fr;gap:14px;min-height:calc(100dvh - 52px);padding:12px}
  .card{background:#0b1323;border:1px solid var(--border);border-radius:14px;padding:12px;margin-bottom:12px}
  h2{margin:4px 0 10px;font-size:14px;color:#cbd5e1}
  label{display:block;font-size:12px;color:#c7d2fe;margin-top:8px}
  input,select,textarea,button{font:inherit}
  input[type="text"],input[type="url"],textarea,select{
    width:100%;padding:10px;border-radius:10px;border:1px solid #27334b;background:#0e1628;color:#e9ecf5
  }
  input[type="file"]{width:100%;padding:8px;border-radius:10px;border:1px dashed #2b3958;background:#0e1628;color:#9fb3ff}
  .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{padding:10px 12px;border-radius:10px;border:1px solid #2a3347;background:#1a233a;color:#fff;cursor:pointer}
  button.primary{background:#2a3569;border-color:#4050a8}
  .muted{color:#9fb0d0;font-size:12px}
  .warn{color:#ffd27a}
  .switchRow{display:flex;gap:10px;align-items:center;margin-top:6px}
  .drop{padding:10px;border:1px dashed #2b3958;border-radius:12px;background:#0e1628;text-align:center}
  .drop.drag{background:#15204a}

  /* Viewport */
  .viewport{position:relative;background:#000;border-radius:14px;overflow:hidden;height:calc(100dvh - 72px)}
  canvas.viewer{display:block;width:100%;height:100%}
  .vpHud{position:absolute;left:8px;top:8px;display:flex;gap:6px;z-index:2}
  .vpHud .btn{padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(17,24,39,.85);color:#fff}

  /* Publish floating panel (aus deinem Snippet) */
  #pub-toggle{position:fixed;right:16px;bottom:16px;z-index:99998;background:#1f2a44;color:#fff;border:1px solid #2a3347;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  #pub-panel{position:fixed;right:16px;bottom:66px;z-index:99999;width:360px;max-width:92vw;background:#0b1323f2;color:#e9ecf5;border:1px solid #2a3347;border-radius:14px;box-shadow:0 20px 48px rgba(0,0,0,.35);display:none}
  #pub-panel header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
  #pub-panel header b{font:600 14px/1.3 system-ui,Segoe UI,Arial}
  #pub-panel .body{padding:10px 12px;display:grid;gap:10px}
  #pub-panel label{display:flex;flex-direction:column;gap:4px;font-size:12px;opacity:.95}
  #pub-panel input[type="text"], #pub-panel input[type="number"]{background:#0e1628;border:1px solid #27334b;color:#e9ecf5;border-radius:8px;padding:8px}
  #pub-panel .row{display:flex;gap:8px;align-items:center}
  #pub-panel .row > *{flex:1}
  #pub-panel button{background:#223049;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:8px 10px;cursor:pointer}
  #pub-panel .muted{opacity:.8;font-size:12px}
  #pub-qr{display:block;margin:6px auto 0 auto;background:#fff;border-radius:8px;max-width:100%}
</style>
</head>
<body>

<!-- PROJECT BAR -->
<div class="bar">
  <span class="title">AR Studio</span>
  <button id="newProj">Neu</button>
  <button id="saveProj" class="primary">Speichern</button>
  <button id="saveAsProj">Speichern unter…</button>
  <select id="openList"><option value="">Projekt öffnen…</option></select>
  <button id="delProj">Löschen</button>
  <span style="margin-left:auto" class="muted" id="projInfo">–</span>
</div>

<div class="layout">
  <!-- LEFT: Inspector -->
  <div>
    <div class="card">
      <h2>Allgemein</h2>
      <label>Projektname<input id="projName" type="text" placeholder="Mein Projekt"></label>
      <div class="switchRow"><strong>Modus:</strong>
        <label><input type="radio" name="mode" value="image" checked> Image-Tracking</label>
        <label><input type="radio" name="mode" value="surface"> Surface-AR</label>
      </div>
      <p class="muted">Im Surface-Modus wird der Target-Block ignoriert.</p>
    </div>

    <div class="card">
      <h2>Modell</h2>
      <div class="switchRow"><strong>Quelle:</strong>
        <label><input type="radio" name="mSrc" value="file" checked> Datei</label>
        <label><input type="radio" name="mSrc" value="url"> URL</label>
      </div>

      <div id="mFileBox">
        <label>GLB Datei</label>
        <div class="drop" id="dropGlb">Datei hierher ziehen oder wählen</div>
        <input id="modelFile" type="file" accept=".glb" style="margin-top:6px">
        <label>USDZ Datei (optional, iOS)</label>
        <input id="usdzFile" type="file" accept=".usdz">
      </div>

      <div id="mUrlBox" style="display:none">
        <label>GLB URL<input id="modelUrl" type="url" placeholder="https://…/model.glb"></label>
        <label>USDZ URL (optional, iOS)<input id="usdzUrl" type="url" placeholder="https://…/model.usdz"></label>
      </div>

      <div class="row2" style="margin-top:8px">
        <div>
          <label>Animation</label>
          <select id="animName">
            <option value="*">alle</option>
            <option value="none">keine</option>
          </select>
        </div>
        <div class="muted" style="align-self:end;text-align:right">W/E/R = Move/Rotate/Scale</div>
      </div>
    </div>

    <div class="card" id="targetCard">
      <h2>Target (nur Image-Modus)</h2>
      <div class="switchRow"><strong>Quelle:</strong>
        <label><input type="radio" name="tSrc" value="file" checked> Dateien</label>
        <label><input type="radio" name="tSrc" value="url"> URLs</label>
      </div>

      <div id="tFileBox">
        <label>.mind Datei<input id="targetMindFile" type="file" accept=".mind"></label>
        <label>Preview-Bild (PNG/JPG)<input id="targetPreviewFile" type="file" accept=".png,.jpg,.jpeg"></label>
      </div>

      <div id="tUrlBox" style="display:none">
        <label>.mind URL<input id="targetMindUrl" type="url" placeholder="/area/assets/targets/target.mind"></label>
        <label>Preview URL<input id="targetPreviewUrl" type="url" placeholder="/area/assets/targets/target.png"></label>
      </div>
    </div>

    <div class="card">
      <h2>Transform</h2>
      <div class="row">
        <label>Pos X<input id="px" type="text" value="0"></label>
        <label>Pos Y<input id="py" type="text" value="0"></label>
        <label>Pos Z<input id="pz" type="text" value="0.05"></label>
      </div>
      <div class="row">
        <label>Rot X°<input id="rx" type="text" value="0"></label>
        <label>Rot Y°<input id="ry" type="text" value="0"></label>
        <label>Rot Z°<input id="rz" type="text" value="0"></label>
      </div>
      <div class="row">
        <label>Scale X<input id="sx" type="text" value="0.6"></label>
        <label>Scale Y<input id="sy" type="text" value="0.6"></label>
        <label>Scale Z<input id="sz" type="text" value="0.6"></label>
      </div>
    </div>

    <div class="card">
      <h2>Licht</h2>
      <div class="row2">
        <label>Hemisphere<input id="hemi" type="text" value="1.2"></label>
        <label>Directional<input id="dirI" type="text" value="1.0"></label>
      </div>
      <div class="row">
        <label>Dir X<input id="dx" type="text" value="0"></label>
        <label>Dir Y<input id="dy" type="text" value="6"></label>
        <label>Dir Z<input id="dz" type="text" value="0"></label>
      </div>
    </div>

    <div class="card">
      <h2>Meta</h2>
      <label>Titel<input id="title" type="text" value="AR-Erlebnis starten"></label>
      <label>Hinweise (eine pro Zeile)<textarea id="tips" rows="3">Achten Sie auf Ihre Umgebung.</textarea></label>
    </div>

    <div class="card">
      <h2>Export</h2>
      <label>Slug (Ordner unter <code>scenes/published/&lt;slug&gt;</code>)
        <input id="slug" type="text" placeholder="demo-project">
      </label>
      <div class="actions">
        <button id="btnZip" class="primary">ZIP: scene.json + Dateien</button>
        <span class="muted">ZIP entpacken und Inhalt nach <b>scenes/published/&lt;slug&gt;/</b> committen (Branch <b>@scenes</b>).</span>
      </div>
    </div>
  </div>

  <!-- RIGHT: Viewport -->
  <div class="viewport">
    <div class="vpHud">
      <button class="btn" id="modeT">W (Move)</button>
      <button class="btn" id="modeR">E (Rotate)</button>
      <button class="btn" id="modeS">R (Scale)</button>
      <button class="btn" id="resetCam">Kamera reset</button>
    </div>
    <canvas id="viewer" class="viewer"></canvas>
  </div>
</div>

<!-- ======== PUBLISH PANEL (kombiniert) ======== -->
<button id="pub-toggle" title="Publish (Surface/Image AR)">Publish</button>
<aside id="pub-panel" role="dialog" aria-modal="false" aria-label="Publish">
  <header>
    <b>Publish – WebAR Link</b>
    <div style="flex:1"></div>
    <button id="pub-close" title="Schließen" style="padding:6px 8px;border-radius:8px">✕</button>
  </header>
  <div class="body">
    <div class="section">
      <h4>Viewer-Ziel & Slug</h4>
      <label>Slug (muss in <code>scenes/published/&lt;slug&gt;/scene.json</code> vorhanden sein)
        <input id="pub-slug" type="text" placeholder="demo-project">
      </label>
      <div class="row">
        <button id="pub-image">Image-AR Link</button>
        <button id="pub-surface-webxr">Surface-AR (WebXR)</button>
        <button id="pub-surface-native">Surface-AR (Native)</button>
      </div>
      <p class="muted">Die Links referenzieren deine vorhandenen Viewer und laden die <code>scene.json</code> über jsDelivr (@scenes).</p>
    </div>

    <label>Link
      <input id="pub-link" type="text" readonly placeholder="Hier erscheint der Link…">
    </label>
    <canvas id="pub-qr" width="0" height="0"></canvas>
    <div class="muted">Tipp: Nach neuem Commit bei jsDelivr ggf. <code>?v=2</code> anhängen (Cache), falls du sofort testen willst.</div>
  </div>
</aside>

<script type="module">
import * as THREE from 'three';
import {OrbitControls} from 'three/addons/controls/OrbitControls.js';
import {TransformControls} from 'three/addons/controls/TransformControls.js';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
import {get,set,del} from 'https://cdn.jsdelivr.net/npm/idb-keyval@6/dist/esm/index.js';

const $ = s=>document.querySelector(s);
const num = (v,f=0)=>{ const n=Number(v); return Number.isFinite(n)?n:f; };
const uuid = ()=>crypto.randomUUID?.():Math.random().toString(36).slice(2);

// ---------- Project state ----------
let project = null;         // current project JSON
let blobs = {};             // {fileId: Blob}
let modelObj = null, mixer=null, gltfAnims=[];
const DB_PREFIX = 'area-studio:';
const PROJ_LIST_KEY = DB_PREFIX+'projects';

// Default project
function defaultProject(){
  return {
    id: uuid(),
    name: 'Unbenannt',
    meta: { title:'AR-Erlebnis starten', tips:['Achten Sie auf Ihre Umgebung.'] },
    mode: 'image',
    transform: { position:[0,0,0.05], rotation:[0,0,0], scale:[0.6,0.6,0.6] },
    lighting: { hemi:1.2, dir:{ intensity:1.0, pos:[0,6,0] } },
    model: { source:'file', fileId:null, fileName:'model.glb', usdzSource:'file', usdzFileId:null, usdzFileName:'model.usdz', url:'', usdzUrl:'', animation:'*' },
    target: { mindSource:'file', mindFileId:null, mindName:'target.mind', mindUrl:'', previewSource:'file', previewFileId:null, previewName:'target.png', previewUrl:'' },
    updatedAt: Date.now()
  };
}

// ---------- THREE Viewer ----------
const canvas = $('#viewer');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:false});
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
const camera = new THREE.PerspectiveCamera(60, 1, 0.01, 100);
resetCamera();
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
const grid = new THREE.GridHelper(10, 20, 0x334455, 0x223344);
grid.material.opacity = 0.35; grid.material.transparent = true;
scene.add(grid);
const axes = new THREE.AxesHelper(0.5); scene.add(axes);
const hemi = new THREE.HemisphereLight(0xffffff, 0x222233, 1.2); scene.add(hemi);
const dir  = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(0,6,0); scene.add(dir);

const tControls = new TransformControls(camera, renderer.domElement);
tControls.addEventListener('dragging-changed', e=>controls.enabled=!e.value);
tControls.addEventListener('objectChange', syncTransformFromObject);
scene.add(tControls);

function resetCamera(){
  camera.position.set(1.6,1.2,2.2);
  camera.lookAt(0,0,0);
  camera.updateProjectionMatrix();
}
$('#resetCam').addEventListener('click', resetCamera);

function resize(){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  if (canvas.width !== w || canvas.height !== h){
    renderer.setSize(w, h, false);
    camera.aspect = w/h; camera.updateProjectionMatrix();
  }
}
const clock = new THREE.Clock();
function animate(){
  resize();
  const dt = clock.getDelta();
  if (mixer) mixer.update(dt);
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}
animate();

// ---------- Loaders ----------
const loader = new GLTFLoader();

// helper: blob -> url
async function blobUrlFrom(file){ return URL.createObjectURL(file); }

// ---------- Model laden ----------
async function loadModelForViewport(){
  if (modelObj){
    tControls.detach();
    scene.remove(modelObj);
    modelObj.traverse(o=>{ if (o.isMesh) o.geometry?.dispose(); });
    modelObj=null; mixer=null; gltfAnims=[];
  }
  let src = '';
  if (project.model.source==='file' && project.model.fileId){
    const file = blobs[project.model.fileId] || await get(DB_PREFIX+'file:'+project.model.fileId);
    if (!file) return;
    src = await blobUrlFrom(file);
  } else if (project.model.source==='url' && project.model.url){
    src = project.model.url;
  } else { return; }

  loader.load(src, (gltf)=>{
    modelObj = gltf.scene;
    gltfAnims = gltf.animations||[];
    applyTransformToObject();
    scene.add(modelObj);
    tControls.attach(modelObj);
    refreshAnimDropdown();
    if (gltfAnims.length && project.model.animation && project.model.animation!=='none'){
      mixer = new THREE.AnimationMixer(modelObj);
      if (project.model.animation==='*') gltfAnims.forEach(c=>mixer.clipAction(c).play());
      else {
        const clip = gltfAnims.find(c=>c.name===project.model.animation) || gltfAnims[0];
        mixer.clipAction(clip).play();
      }
    }
  }, undefined, (err)=>alert('GLB konnte nicht geladen werden: '+err.message));
}

function applyTransformToObject(){
  if (!modelObj) return;
  const t = project.transform;
  modelObj.position.set(t.position[0], t.position[1], t.position[2]);
  modelObj.rotation.set(THREE.MathUtils.degToRad(t.rotation[0]), THREE.MathUtils.degToRad(t.rotation[1]), THREE.MathUtils.degToRad(t.rotation[2]));
  modelObj.scale.set(t.scale[0], t.scale[1], t.scale[2]);
}
function syncTransformFromObject(){
  if (!modelObj) return;
  const p = modelObj.position, r = modelObj.rotation, s = modelObj.scale;
  project.transform.position = [p.x, p.y, p.z];
  project.transform.rotation = [THREE.MathUtils.radToDeg(r.x), THREE.MathUtils.radToDeg(r.y), THREE.MathUtils.radToDeg(r.z)];
  project.transform.scale    = [s.x, s.y, s.z];
  updateTransformInputs();
}
function updateTransformInputs(){
  const t = project.transform;
  $('#px').value=t.position[0]; $('#py').value=t.position[1]; $('#pz').value=t.position[2];
  $('#rx').value=t.rotation[0]; $('#ry').value=t.rotation[1]; $('#rz').value=t.rotation[2];
  $('#sx').value=t.scale[0];    $('#sy').value=t.scale[1];    $('#sz').value=t.scale[2];
}
function readTransformFromInputs(){
  const t = project.transform;
  t.position=[num($('#px').value),num($('#py').value),num($('#pz').value)];
  t.rotation=[num($('#rx').value),num($('#ry').value),num($('#rz').value)];
  t.scale   =[num($('#sx').value,1),num($('#sy').value,1),num($('#sz').value,1)];
  applyTransformToObject();
}
['#px','#py','#pz','#rx','#ry','#rz','#sx','#sy','#sz'].forEach(sel=> $(sel).addEventListener('change', readTransformFromInputs));

// Gizmo mode + keys
const setGizmoMode = m => tControls.setMode(m);
$('#modeT').addEventListener('click', ()=>setGizmoMode('translate'));
$('#modeR').addEventListener('click', ()=>setGizmoMode('rotate'));
$('#modeS').addEventListener('click', ()=>setGizmoMode('scale'));
window.addEventListener('keydown', (e)=>{
  if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
  if (e.key==='w'||e.key==='W') setGizmoMode('translate');
  if (e.key==='e'||e.key==='E') setGizmoMode('rotate');
  if (e.key==='r'||e.key==='R') setGizmoMode('scale');
});

// Lighting inputs
['#hemi','#dirI','#dx','#dy','#dz'].forEach(sel=>{
  $(sel).addEventListener('change', ()=>{
    project.lighting.hemi = num($('#hemi').value,1.0);
    project.lighting.dir.intensity = num($('#dirI').value,1.0);
    project.lighting.dir.pos = [num($('#dx').value),num($('#dy').value),num($('#dz').value)];
    hemi.intensity = project.lighting.hemi;
    dir.intensity = project.lighting.dir.intensity;
    const [x,y,z]=project.lighting.dir.pos; dir.position.set(x,y,z);
  });
});

// Model source switching + drag&drop
function toggleSourceBoxes(){
  const mFile = document.querySelector('input[name="mSrc"][value="file"]').checked;
  $('#mFileBox').style.display = mFile?'':'none';
  $('#mUrlBox').style.display  = mFile?'none':'';
  const tFile = document.querySelector('input[name="tSrc"][value="file"]').checked;
  $('#tFileBox').style.display = tFile?'':'none';
  $('#tUrlBox').style.display  = tFile?'none':'';
}
document.querySelectorAll('input[name="mSrc"],input[name="tSrc"]').forEach(r=>r.addEventListener('change', ()=>{
  if (r.name==='mSrc') project.model.source = r.value;
  if (r.name==='tSrc'){ project.target.mindSource=r.value; project.target.previewSource=r.value; }
  toggleSourceBoxes();
}));

const drop = $('#dropGlb');
['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.add('drag');}));
['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();drop.classList.remove('drag');}));
drop.addEventListener('drop', async (e)=>{
  const file = [...e.dataTransfer.files].find(f=>f.name.toLowerCase().endsWith('.glb'));
  if (!file) return;
  await importGLBFile(file);
});
$('#modelFile').addEventListener('change', async e=>{ const f=e.target.files[0]; if(f) await importGLBFile(f); });
$('#usdzFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const id = uuid(); blobs[id]=f; await set(DB_PREFIX+'file:'+id, f);
  project.model.usdzFileId=id; project.model.usdzFileName=f.name||'model.usdz';
});
$('#targetMindFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const id=uuid(); blobs[id]=f; await set(DB_PREFIX+'file:'+id, f);
  project.target.mindFileId=id; project.target.mindName=f.name||'target.mind';
});
$('#targetPreviewFile').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return;
  const id=uuid(); blobs[id]=f; await set(DB_PREFIX+'file:'+id, f);
  project.target.previewFileId=id; project.target.previewName=f.name||'target.png';
});
$('#modelUrl').addEventListener('change', e=>{ project.model.url = e.target.value.trim(); });
$('#usdzUrl').addEventListener('change', e=>{ project.model.usdzUrl = e.target.value.trim(); });
$('#targetMindUrl').addEventListener('change', e=>{ project.target.mindUrl = e.target.value.trim(); });
$('#targetPreviewUrl').addEventListener('change', e=>{ project.target.previewUrl = e.target.value.trim(); });

function refreshAnimDropdown(){
  const box = $('#animName');
  const cur = box.value;
  box.innerHTML = '';
  if (!gltfAnims.length){ box.insertAdjacentHTML('beforeend','<option value="none">keine</option>'); project.model.animation='none'; }
  else {
    box.insertAdjacentHTML('beforeend','<option value="*">alle</option>');
    gltfAnims.forEach(c=>box.insertAdjacentHTML('beforeend', `<option value="${c.name}">${c.name}</option>`));
    box.value = gltfAnims.some(c=>c.name===cur)?cur:'*';
    project.model.animation = box.value;
  }
}
$('#animName').addEventListener('change', e=>{ project.model.animation = e.target.value; loadModelForViewport(); });

async function importGLBFile(file){
  const id = uuid();
  blobs[id]=file; await set(DB_PREFIX+'file:'+id, file);
  project.model.source='file'; project.model.fileId=id; project.model.fileName=file.name||'model.glb';
  document.querySelector('input[name="mSrc"][value="file"]').checked = true;
  toggleSourceBoxes();
  await loadModelForViewport();
}

// ---------- scene.json ----------
function buildSceneJSON(relPathsForZip=false){
  const scene = {
    meta: { version:'1.0', mode: project.mode, title: project.meta.title, tips: project.meta.tips },
    model: {
      url: project.model.source==='url' ? (project.model.url||'') :
           (relPathsForZip ? './'+(project.model.fileName||'model.glb') : ''),
      usdzUrl: (project.model.usdzFileId
                ? (relPathsForZip ? './'+(project.model.usdzFileName||'model.usdz') : '')
                : (project.model.usdzUrl||'')) || undefined,
      position: project.transform.position,
      rotation: project.transform.rotation,
      scale:    project.transform.scale,
      animation: project.model.animation||'none'
    },
    lighting: project.lighting,
    audio: { url:null, loop:true, volume:0.8, autoplayOnTarget:false }
  };
  if (project.mode==='image'){
    scene.target = {
      mindUrl: (project.target.mindFileId ? (relPathsForZip ? './'+(project.target.mindName||'target.mind') : '') : (project.target.mindUrl||'')),
      previewUrl: (project.target.previewFileId ? (relPathsForZip ? './'+(project.target.previewName||'target.png') : '') : (project.target.previewUrl||''))
    };
  }
  return scene;
}

// ---------- ZIP export ----------
async function exportZIP(){
  const slug = $('#slug').value.trim()||'scene';
  const zip = new JSZip();
  const scene = buildSceneJSON(true);
  zip.file('scene.json', JSON.stringify(scene,null,2));

  if (project.model.fileId){
    const b = blobs[project.model.fileId] || await get(DB_PREFIX+'file:'+project.model.fileId);
    if (b) zip.file(project.model.fileName||'model.glb', b);
  }
  if (project.model.usdzFileId){
    const b = blobs[project.model.usdzFileId] || await get(DB_PREFIX+'file:'+project.model.usdzFileId);
    if (b) zip.file(project.model.usdzFileName||'model.usdz', b);
  }
  if (project.mode==='image'){
    if (project.target.mindFileId){
      const b = blobs[project.target.mindFileId] || await get(DB_PREFIX+'file:'+project.target.mindFileId);
      if (b) zip.file(project.target.mindName||'target.mind', b);
    }
    if (project.target.previewFileId){
      const b = blobs[project.target.previewFileId] || await get(DB_PREFIX+'file:'+project.target.previewFileId);
      if (b) zip.file(project.target.previewName||'target.png', b);
    }
  }

  const blob = await zip.generateAsync({type:'blob'});
  const a = document.createElement('a');
  a.download = `${slug}.zip`; a.href = URL.createObjectURL(blob); a.click();
  URL.revokeObjectURL(a.href);
}
$('#btnZip').addEventListener('click', exportZIP);

// ---------- Projects (IndexedDB) ----------
async function saveProject(asNew=false){
  if (asNew || !project.id) project.id = uuid();
  project.name = $('#projName').value.trim() || 'Unbenannt';
  project.updatedAt = Date.now();
  await set(DB_PREFIX+'project:'+project.id, project);
  // update list
  let list = await get(PROJ_LIST_KEY) || [];
  const idx = list.findIndex(p=>p.id===project.id);
  const entry = {id:project.id, name:project.name, updatedAt:project.updatedAt};
  if (idx>=0) list[idx]=entry; else list.push(entry);
  await set(PROJ_LIST_KEY, list);
  await refreshOpenList();
  updateBar();
}
async function refreshOpenList(){
  const list = (await get(PROJ_LIST_KEY)) || [];
  list.sort((a,b)=>b.updatedAt-a.updatedAt);
  const sel = $('#openList'); sel.innerHTML='<option value="">Projekt öffnen…</option>';
  list.forEach(p=>{
    const o=document.createElement('option'); o.value=p.id; o.textContent=`${p.name} – ${new Date(p.updatedAt).toLocaleString()}`;
    sel.appendChild(o);
  });
}
async function openProject(id){
  const data = await get(DB_PREFIX+'project:'+id);
  if (!data){ alert('Projekt nicht gefunden.'); return; }
  project = data;
  fillUIFromProject();
  await loadModelForViewport();
}
async function deleteProject(){
  if (!project?.id) return;
  if (!confirm('Projekt löschen?')) return;
  await del(DB_PREFIX+'project:'+project.id);
  let list = (await get(PROJ_LIST_KEY)) || [];
  list = list.filter(p=>p.id!==project.id); await set(PROJ_LIST_KEY, list);
  project = defaultProject();
  fillUIFromProject(); await refreshOpenList(); await loadModelForViewport();
}

function updateBar(){ $('#projInfo').textContent = project?.name ? `Projekt: ${project.name}` : '–'; }
function fillUIFromProject(){
  $('#projName').value = project.name || 'Unbenannt';
  document.querySelector(`input[name="mode"][value="${project.mode||'image'}"]`).checked = true;
  $('#targetCard').style.display = project.mode==='image' ? '' : 'none';
  document.querySelector(`input[name="mSrc"][value="${project.model.source||'file'}"]`).checked = true;
  document.querySelectorAll('input[name="tSrc"]').forEach(r=> r.checked = (r.value === (project.target.mindSource||'file')));
  toggleSourceBoxes();
  $('#modelUrl').value = project.model.url||'';
  $('#usdzUrl').value = project.model.usdzUrl||'';
  $('#targetMindUrl').value = project.target.mindUrl||'';
  $('#targetPreviewUrl').value = project.target.previewUrl||'';
  updateTransformInputs();
  $('#hemi').value = project.lighting.hemi; $('#dirI').value = project.lighting.dir.intensity;
  $('#dx').value = project.lighting.dir.pos[0]; $('#dy').value = project.lighting.dir.pos[1]; $('#dz').value = project.lighting.dir.pos[2];
  $('#title').value = project.meta.title||''; $('#tips').value = (project.meta.tips||[]).join('\n');
  updateBar();
}

// Topbar Events
$('#newProj').addEventListener('click', async ()=>{ project = defaultProject(); fillUIFromProject(); await loadModelForViewport(); });
$('#saveProj').addEventListener('click', ()=>saveProject(false));
$('#saveAsProj').addEventListener('click', ()=>saveProject(true));
$('#openList').addEventListener('change', async e=>{ if (e.target.value) await openProject(e.target.value); });
$('#delProj').addEventListener('click', deleteProject);

// Init
project = defaultProject();
fillUIFromProject();
await refreshOpenList();
await loadModelForViewport();

// ---------- Publish Panel: Links + QR (nutzt deine Viewer + jsDelivr) ----------
const pubToggle = $('#pub-toggle'), pubPanel = $('#pub-panel'), pubClose = $('#pub-close');
pubToggle.addEventListener('click', ()=>{ pubPanel.style.display = (pubPanel.style.display==='block') ? 'none' : 'block'; });
pubClose.addEventListener('click', ()=> pubPanel.style.display='none');

function sceneUrlFromSlug(slug){
  if (!slug) return '';
  return `https://cdn.jsdelivr.net/gh/krischihh/area@scenes/scenes/published/${encodeURIComponent(slug)}/scene.json`;
}
function drawQR(text){
  const cnv = $('#pub-qr'); if (!window.QRCode || !cnv) return;
  QRCode.toCanvas(cnv, text, { errorCorrectionLevel:'L', width: 280, margin:1 }, ()=>{});
}
function setLinkOut(url){
  const out = $('#pub-link'); out.value = url || '—';
  if (url) drawQR(url);
}

// Buttons
$('#pub-image').addEventListener('click', ()=>{
  const slug = $('#pub-slug').value.trim();
  if (!slug) return setLinkOut('Bitte Slug eingeben.');
  const scene = sceneUrlFromSlug(slug);
  const url = `https://krischihh.github.io/area/image-ar/viewer.html?scene=${encodeURIComponent(scene)}`;
  setLinkOut(url);
});
$('#pub-surface-webxr').addEventListener('click', ()=>{
  const slug = $('#pub-slug').value.trim();
  if (!slug) return setLinkOut('Bitte Slug eingeben.');
  const scene = sceneUrlFromSlug(slug);
  const url = `https://krischihh.github.io/area/surface-ar/webxr.html?scene=${encodeURIComponent(scene)}`;
  setLinkOut(url);
});
$('#pub-surface-native').addEventListener('click', ()=>{
  const slug = $('#pub-slug').value.trim();
  if (!slug) return setLinkOut('Bitte Slug eingeben.');
  const scene = sceneUrlFromSlug(slug);
  const url = `https://krischihh.github.io/area/surface-ar/index.html?scene=${encodeURIComponent(scene)}`;
  setLinkOut(url);
});
</script>
</body>
</html>
