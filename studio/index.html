<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor with Publish (Standalone, alles inline)</title>
  <style>
    :root { --bg:#0e1116; --panel:#0b1323; --muted:#94a3b8; --fg:#e9ecf5; --border:#24314a; --accent:#223049; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Arial}
    header.top{display:flex;align-items:center;gap:12px;padding:12px;background:var(--panel);border-bottom:1px solid var(--border)}
    header.top b{font-weight:600}
    header.top .muted{color:var(--muted)}
    main{padding:12px}
    .hidden{display:none!important}

    /* Publish Panel */
    #pub-toggle{position:fixed;right:16px;bottom:16px;z-index:99998;background:#1f2a44;color:#fff;
      border:1px solid #2a3347;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    #pub-panel{position:fixed;right:16px;bottom:66px;z-index:99999;width:360px;max-width:92vw;background:#0b1323f2;color:#e9ecf5;
      border:1px solid #2a3347;border-radius:14px;box-shadow:0 20px 48px rgba(0,0,0,.35);display:none}
    #pub-panel header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    #pub-panel header b{font:600 14px/1.3 system-ui,Segoe UI,Arial}
    #pub-panel .body{padding:10px 12px;display:grid;gap:10px}
    #pub-panel label{display:flex;flex-direction:column;gap:4px;font-size:12px;opacity:.95}
    #pub-panel input[type="text"], #pub-panel input[type="number"]{background:#0e1628;border:1px solid #27334b;color:#e9ecf5;
      border-radius:8px;padding:8px}
    #pub-panel .row{display:flex;gap:8px;align-items:center}
    #pub-panel .row > *{flex:1}
    #pub-panel button{background:#223049;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:8px 10px;cursor:pointer}
    #pub-panel .muted{opacity:.8;font-size:12px}
    #pub-qr{display:block;margin:6px auto 0 auto; background:#fff; border-radius:8px; max-width:100%}

    /* Manual config section */
    .section{border:1px solid var(--border); border-radius:12px; padding:10px}
    .section h4{margin:0 0 8px 0; font-size:13px; color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:8px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
    .small{font-size:12px;color:#a6b4cf}
    .notice{padding:8px;border:1px dashed var(--border); border-radius:10px; background:#0b1323cc; color:#cbd5e1}
    code{background:#0b1220;padding:0 4px;border-radius:4px}
  </style>
</head>
<body>
  <header class="top">
    <b>Editor + Publish Panel</b>
    <span class="muted">Einbaufertiger Publish-Block. Alles CSS/JS inline.</span>
    <span style="flex:1"></span>
    <a href="#" id="demoSelect" style="color:#a5b4fc;text-decoration:underline">Demo: Auswahl simulieren</a>
  </header>
  <main>
    <div class="notice">
      <b>Hinweis:</b> Diese Datei enthält <i>nur</i> das Publish-Panel mit optionaler <b>manueller Szenenkonfiguration</b>.<br>
      In deiner echten Editor-HTML wird normalerweise aus <code>state.objects</code> + <code>state.selectedId</code> gelesen.
      Fehlt diese API, nutze unten die <b>manuelle Szene</b>.
    </div>
  </main>

  <!-- ======== PUBLISH PANEL ======== -->
  <button id="pub-toggle" title="Publish (Surface/Image AR)">Publish</button>
  <aside id="pub-panel" role="dialog" aria-modal="false" aria-label="Publish">
    <header>
      <b>Publish – WebAR Link</b>
      <div style="flex:1"></div>
      <button id="pub-close" title="Schließen" style="padding:6px 8px;border-radius:8px">✕</button>
    </header>
    <div class="body">
      <label>Viewer URL (HTTPS empfohlen)
        <input id="pub-viewer-url" type="text" value="./viewer.html" placeholder="./viewer.html">
      </label>

      <div class="section">
        <h4>Quelle wählen</h4>
        <div class="row">
          <button id="pub-surface">Surface‑AR Link</button>
          <button id="pub-image">Image‑AR Link</button>
        </div>
        <div class="row">
          <input id="pub-image-file" type="file" accept="image/*">
          <label>Bildbreite (m)
            <input id="pub-image-width" type="number" step="0.01" min="0.05" value="0.20">
          </label>
        </div>
      </div>

      <div class="section">
        <h4>Manuelle Szene (Fallback, wenn keine Editor-Auswahl)</h4>
        <label>GLB/GLTF URL (oder Data URL)
          <input id="m-src" type="text" placeholder="https://.../model.glb">
        </label>
        <div class="grid-3">
          <label>Scale<input id="m-scale" type="number" step="0.01" value="1"></label>
          <label>Anim Index<input id="m-anim" type="number" step="1" value="0"></label>
          <label>Audio URL<input id="m-audio" type="text" placeholder="optional"></label>
        </div>
        <div class="grid-3">
          <label>Rot X°<input id="m-rx" type="number" step="1" value="0"></label>
          <label>Rot Y°<input id="m-ry" type="number" step="1" value="0"></label>
          <label>Rot Z°<input id="m-rz" type="number" step="1" value="0"></label>
        </div>
        <div class="grid-3">
          <label>Pos X<input id="m-px" type="number" step="0.01" value="0"></label>
          <label>Pos Y<input id="m-py" type="number" step="0.01" value="0"></label>
          <label>Pos Z<input id="m-pz" type="number" step="0.01" value="0"></label>
        </div>
        <label class="small"><input id="m-enable" type="checkbox"> Manuelle Szene aktivieren (wenn kein Editor-Objekt gewählt ist)</label>
      </div>

      <label>Link
        <input id="pub-link" type="text" readonly placeholder="Hier erscheint der Link…">
      </label>
      <canvas id="pub-qr" width="0" height="0"></canvas>
      <div class="small">Scanne den QR-Code oder kopiere den Link. Für AR ist HTTPS erforderlich.</div>
    </div>
  </aside>

  <script>
    // --- optional: kleine Demo-Auswahl ---
    document.getElementById('demoSelect').addEventListener('click', (e)=>{
      e.preventDefault();
      // Minimaler Demo-Editor-State
      window.state = {
        selectedId: 'demo1',
        objects: [{
          id: 'demo1',
          url: 'https://threejs.org/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf',
          group: { // Fake Transform (nur für snapshot in diesem Demo-File)
            position: {x:0,y:0,z:0},
            rotation: {x:0,y:0,z:0},
            scale: {x:1,y:1,z:1}
          },
          animIndex: 0,
          audioURL: ''
        }]
      };
      alert('Demo-Auswahl gesetzt. Öffne das Publish-Panel.');
    });
  </script>

  <script>
  (function(){
    const $ = (s)=> document.querySelector(s);
    const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);

    // Optional QR lib von CDN (klein & robust)
    const QR_URL = "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
    function ensureQRLib(){
      return new Promise((resolve)=>{
        if (window.QRCode) return resolve();
        const s = document.createElement('script');
        s.src = QR_URL; s.async = true;
        s.onload = ()=> resolve();
        s.onerror = ()=> resolve();
        document.head.appendChild(s);
      });
    }
    async function drawQR(text){
      await ensureQRLib();
      const cnv = $("#pub-qr");
      if(!window.QRCode || !cnv){ cnv.hidden=true; return; }
      try{
        const opts = { errorCorrectionLevel:'L', width: 280, margin:1, color:{ dark:"#000000", light:"#ffffff" } };
        const dataUrl = await window.QRCode.toDataURL(text, opts);
        const img = new Image();
        img.onload = ()=>{
          cnv.width = img.width; cnv.height = img.height;
          const ctx = cnv.getContext('2d');
          ctx.clearRect(0,0,cnv.width,cnv.height);
          ctx.drawImage(img, 0, 0);
          cnv.hidden = false;
        };
        img.src = dataUrl;
      }catch(e){ cnv.hidden=true; }
    }

    function encodeHash(obj){
      const json = JSON.stringify(obj);
      return '#' + btoa(unescape(encodeURIComponent(json)));
    }

    // Fallback-Utils
    window.fileToBase64 = window.fileToBase64 || (file => new Promise((res,rej)=>{
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
    }));
    window.snapshotTransform = window.snapshotTransform || (group => ({
      position:[group.position.x, group.position.y, group.position.z],
      rotationDeg:[group.rotation.x*180/Math.PI, group.rotation.y*180/Math.PI, group.rotation.z*180/Math.PI],
      scale: group.scale.x
    }));

    // Build Payload aus Editor-Auswahl ODER manueller Szene
    async function buildScenePayload(){
      // 1) Zuerst Editor prüfen
      if(window.state && Array.isArray(state.objects)){
        const sid = state.selectedId;
        const rec = state.objects.find(o=>o.id===sid);
        if(sid && rec && rec.group){
          let src = rec.url || rec.src || null;
          if(!src && rec.file && typeof fileToBase64==='function'){
            src = await fileToBase64(rec.file);
          }
          if(!src) throw new Error('Keine GLB/GLTF-Quelle beim Objekt (Editor) gefunden');
          const t = (typeof snapshotTransform==='function') ? snapshotTransform(rec.group) : {
            position:[0,0,0], rotationDeg:[0,0,0], scale:1
          };
          const animIndex = (typeof rec.animIndex==='number') ? rec.animIndex : 0;
          const audio = rec.audioURL || null;
          return { src, scale: t.scale, rotationDeg: t.rotationDeg, position: t.position, animIndex, audio };
        }
      }
      // 2) Manuelle Szene wenn aktiviert
      if($('#m-enable')?.checked){
        const src = $('#m-src').value.trim();
        if(!src) throw new Error('Manuelle Szene: GLB/GLTF URL fehlt');
        const scale = parseFloat($('#m-scale').value||'1')||1;
        const animIndex = parseInt($('#m-anim').value||'0',10)||0;
        const audio = ($('#m-audio').value||'').trim() || null;
        const rx = parseFloat($('#m-rx').value||'0')||0;
        const ry = parseFloat($('#m-ry').value||'0')||0;
        const rz = parseFloat($('#m-rz').value||'0')||0;
        const px = parseFloat($('#m-px').value||'0')||0;
        const py = parseFloat($('#m-py').value||'0')||0;
        const pz = parseFloat($('#m-pz').value||'0')||0;
        return {
          src, scale, rotationDeg:[rx,ry,rz], position:[px,py,pz], animIndex, audio
        };
      }
      throw new Error('Kein Objekt gewählt und manuelle Szene nicht aktiviert.');
    }

    function baseViewerURL(){
      return $("#pub-viewer-url")?.value?.trim() || "./viewer.html";
    }

    async function makeSurfaceARLink(){
      const payload = await buildScenePayload();
      payload.mode = 'surface';
      return baseViewerURL() + encodeHash(payload);
    }

    async function makeImageARLink(file, widthMeters){
      if(!file) throw new Error('Kein Trigger-Bild gewählt');
      if(typeof fileToBase64!=='function') throw new Error('fileToBase64 fehlt');
      const imgData = await fileToBase64(file);
      const payload = await buildScenePayload();
      payload.mode = 'image';
      payload.image = imgData;
      payload.imageWidthMeters = Number(widthMeters)||0.2;
      return baseViewerURL() + encodeHash(payload);
    }

    // UI
    const toggle = $("#pub-toggle");
    const panel = $("#pub-panel");
    on(toggle, 'click', ()=> { panel.style.display = (panel.style.display==='none'||!panel.style.display) ? 'block' : 'none'; });
    on($("#pub-close"), 'click', ()=> { panel.style.display='none'; });

    on($("#pub-surface"), 'click', async ()=>{
      const out = $("#pub-link");
      try{
        const link = await makeSurfaceARLink();
        out.value = link;
        drawQR(link);
      }catch(e){ out.value = e.message; }
    });

    on($("#pub-image"), 'click', async ()=>{
      const out = $("#pub-link");
      try{
        const file = $("#pub-image-file")?.files?.[0];
        const width = $("#pub-image-width")?.value || '0.2';
        const link = await makeImageARLink(file, width);
        out.value = link;
        drawQR(link);
      }catch(e){ out.value = e.message; }
    });

    // Close on Escape
    window.addEventListener('keydown', (e)=>{
      if(e.key==='Escape' && panel.style.display==='block'){ panel.style.display='none'; }
    }, true);
  })();
  </script>
</body>
</html>
