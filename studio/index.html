<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AR Studio – Editor + Viewport + Publish</title>
<style>
  :root{--bg:#0e1116;--panel:#0b1323;--muted:#94a3b8;--fg:#e9ecf5;--border:#24314a}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
  body{display:flex;flex-direction:column}
  header.top{display:flex;gap:12px;align-items:center;padding:10px 12px;background:var(--panel);border-bottom:1px solid var(--border)}
  header.top b{font-weight:700}
  header.top .muted{color:var(--muted)}
  main.app{flex:1;min-height:0;display:grid;grid-template-columns:280px 1fr}
  aside.sidebar{border-right:1px solid var(--border);padding:10px 10px 14px;overflow:auto}
  #viewport{position:relative;background:#0b0f18;min-height:0}
  #canvasWrap{position:absolute;inset:0}
  .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"],input[type="number"],select{width:100%;background:#0e1628;border:1px solid #27334b;color:#e9ecf5;border-radius:8px;padding:8px}
  input[type="file"]{width:100%}
  button{background:#223049;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:8px 10px;cursor:pointer}
  .muted{color:#a6b4cf}
  .small{font-size:12px;color:#a6b4cf}
  .hline{height:1px;background:var(--border);margin:10px 0}
  .toolbar{position:absolute;left:max(12px,env(safe-area-inset-left));top:max(12px,env(safe-area-inset-top));display:flex;gap:6px;z-index:5}
  .chip{background:#111a2a;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:6px 10px}
  #status{position:absolute;left:max(12px,env(safe-area-inset-left));bottom:max(10px,env(safe-area-inset-bottom));z-index:5;opacity:.9}
  #err{position:fixed;left:12px;top:12px;z-index:99;background:#b00020;padding:8px 10px;border-radius:8px;display:none;font:12px/1.35 monospace;max-width:min(92vw,680px);white-space:pre-wrap}
  #pub-toggle{position:fixed;right:16px;bottom:16px;z-index:99998;background:#1f2a44;color:#fff;border:1px solid #2a3347;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
  #pub-panel{position:fixed;right:16px;bottom:66px;z-index:99999;width:360px;max-width:92vw;background:#0b1323f2;color:#e9ecf5;border:1px solid #2a3347;border-radius:14px;box-shadow:0 20px 48px rgba(0,0,0,.35);display:none}
  #pub-panel header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
  #pub-panel .body{padding:10px 12px;display:grid;gap:10px}
  #pub-panel .row>*{flex:1}
  #pub-qr{display:block;margin:6px auto 0;background:#fff;border-radius:8px;max-width:100%}
  #dropHint{position:absolute;inset:0;border:2px dashed #3a4d7a;border-radius:12px;margin:12px;display:none;align-items:center;justify-content:center;color:#cbd5e1;background:rgba(17,26,42,.35);z-index:6}
</style>

<!-- Direkte CDN-Imports (keine Import-Map nötig) -->
<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { GLTFLoader } from 'https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
import { TransformControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/TransformControls.js';

const $ = s=>document.querySelector(s);
const status = (t)=> $("#status").textContent = t;
const showErr = (m)=>{ const el=$("#err"); el.textContent=m; el.style.display='block'; console.error(m); setTimeout(()=>el.style.display='none', 6000); };

// THREE state
let scene, camera, renderer, orbit, gizmo, grid, axes;
let model=null, mixer=null, clips=[], publishSrc=null;

init3D();
resize(); addEventListener('resize', resize);

function init3D(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0f18);

  camera = new THREE.PerspectiveCamera(50, 16/9, 0.01, 200);
  camera.position.set(1.8, 1.2, 2.4);

  renderer = new THREE.WebGLRenderer({antialias:true, alpha:false, powerPreference:'low-power'});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.setPixelRatio(Math.min(devicePixelRatio||1,1.8));
  $("#canvasWrap").appendChild(renderer.domElement);

  const amb = new THREE.HemisphereLight(0xffffff, 0x223355, 1.0); scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 1.15); dir.position.set(3,5,2); scene.add(dir);

  orbit = new OrbitControls(camera, renderer.domElement);
  orbit.enableDamping = true;

  gizmo = new TransformControls(camera, renderer.domElement);
  gizmo.addEventListener('dragging-changed', e=> orbit.enabled = !e.value);
  scene.add(gizmo);

  // gut sichtbares Grid + Axes
  grid = new THREE.GridHelper(10, 20, 0x88aaff, 0x5577ff);
  grid.material.transparent = true; grid.material.opacity = 0.9;
  scene.add(grid);
  axes = new THREE.AxesHelper(0.5); axes.renderOrder = 1; scene.add(axes);

  // Drag & Drop
  const vp=$("#viewport"), hint=$("#dropHint");
  ['dragenter','dragover'].forEach(ev=> vp.addEventListener(ev, e=>{ e.preventDefault(); hint.style.display='flex'; }));
  ['dragleave','drop'].forEach(ev=> vp.addEventListener(ev, e=>{ e.preventDefault(); hint.style.display='none'; }));
  vp.addEventListener('drop', async (e)=>{ const f=e.dataTransfer.files?.[0]; if(f) await loadFromFile(f); });

  animate();
}
function resize(){ const el=$("#viewport"); const w=el.clientWidth, h=el.clientHeight; renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix(); }

const loader = new GLTFLoader();

const readFileDual = (file)=> new Promise((resolve,reject)=>{
  const r1=new FileReader(), r2=new FileReader();
  r1.onload=()=>{ const blob=new Blob([r1.result]); const blobUrl=URL.createObjectURL(blob);
    r2.onload=()=> resolve({blobUrl, dataUrl:r2.result});
    r2.onerror=reject; r2.readAsDataURL(file);
  };
  r1.onerror=reject; r1.readAsArrayBuffer(file);
});

async function loadFromFile(file){
  try{
    status('Lade Datei…'); const {blobUrl, dataUrl} = await readFileDual(file);
    await loadFromSrc(blobUrl, file.name);
    publishSrc = dataUrl; // für Publish (Data-URL)
  }catch(err){ showErr('Datei konnte nicht geladen werden: '+err.message); }
}
async function loadFromURL(url){
  publishSrc = url; // Viewer lädt per URL (CORS nötig)
  await loadFromSrc(url);
}

async function loadFromSrc(src, niceName=''){
  status('Lade Modell…');
  if (model){ gizmo.detach(); scene.remove(model); disposeObject(model); }
  if (mixer){ mixer.stopAllAction(); mixer.uncacheRoot(model); mixer=null; }
  clips=[]; setAnimUI([]);

  return new Promise((resolve,reject)=>{
    loader.load(src, gltf=>{
      model = gltf.scene || gltf.scenes?.[0];
      if(!model){ reject(new Error('Kein Scene-Root im GLTF')); return; }
      model.position.set(0,0,0);
      model.rotation.set(0,0,0);
      model.scale.set(1,1,1);
      scene.add(model);
      gizmo.attach(model);

      const name = niceName || (typeof src==='string' ? src.split('/').pop() : 'Modell');
      $("#modelName").textContent = name;

      clips = gltf.animations||[];
      if (clips.length) mixer = new THREE.AnimationMixer(model);
      setAnimUI(clips.map(c=>c.name||''));
      status(`${name} geladen · ${clips.length} Animation(en)`);
      syncTransformInputsFromModel();
      resolve();
    }, undefined, err=>{ showErr('Laden fehlgeschlagen: '+err.message); reject(err); });
  });
}

function disposeObject(root){
  root.traverse(o=>{
    if (o.geometry) o.geometry.dispose();
    if (o.material){ const m=o.material; Array.isArray(m) ? m.forEach(x=>x.dispose()) : m.dispose(); }
  });
}

function setAnimUI(names){
  const sel=$("#anim-name"); const keep=sel.value;
  sel.innerHTML='<option value="*">alle</option>';
  names.forEach(n=> sel.insertAdjacentHTML('beforeend', `<option value="${n}">${n||'(unbenannt)'}</option>`));
  if ([...sel.options].some(o=>o.value===keep)) sel.value=keep;
}

function playSelection(){
  if (!mixer || !clips.length) return;
  mixer.stopAllAction();
  mixer.timeScale = parseFloat($("#anim-speed").value||'1')||1;
  const loop=$("#anim-loop").checked;
  const pick=$("#anim-name").value;
  let acts=[];
  if (pick==='*'){ acts = clips.map(c=>mixer.clipAction(c)); }
  else { const c = clips.find(c=>c.name===pick) || clips[0]; if (c) acts=[mixer.clipAction(c)]; }
  acts.forEach(a=>{ a.clampWhenFinished=!loop; a.setLoop(loop?THREE.LoopRepeat:THREE.LoopOnce, Infinity).play(); });
}
function pauseAll(){ if (mixer){ mixer.timeScale = 0; } }

$("#demo-load").onclick = async ()=>{ await loadFromURL('https://modelviewer.dev/shared-assets/models/Astronaut.glb'); };
$("#btn-load").onclick = async ()=>{
  const f=$("#f-file").files[0]; const url=($("#f-url").value||'').trim();
  if (f) await loadFromFile(f);
  else if (url) await loadFromURL(url);
  else alert('Datei auswählen oder URL eintragen.');
};
$("#btn-probe").onclick = async ()=>{
  if (!publishSrc){ const f=$("#f-file").files[0]; const url=($("#f-url").value||'').trim();
    if (f) await loadFromFile(f); else if (url) await loadFromURL(url); else return alert('Datei oder URL angeben.');
  } else { setAnimUI(clips.map(c=>c.name||'')); }
};

$("#anim-play").onclick = playSelection;
$("#anim-pause").onclick = pauseAll;
$("#anim-name").onchange = ()=>{ if(mixer) playSelection(); };
$("#anim-speed").onchange = ()=>{ if(mixer) playSelection(); };
$("#anim-loop").onchange = ()=>{ if(mixer) playSelection(); };

document.querySelectorAll('[data-gizmo]').forEach(btn=> btn.onclick = ()=> gizmo.setMode(btn.dataset.gizmo));

$("#grid-toggle").onchange = ()=>{ const v=$("#grid-toggle").checked; grid.visible = v; axes.visible = v; };
$("#cam-reset").onclick = ()=>{ camera.position.set(1.8,1.2,2.4); orbit.target.set(0,0,0); orbit.update(); };

function syncTransformInputsFromModel(){
  if (!model) return;
  $("#p-x").value = model.position.x.toFixed(2);
  $("#p-y").value = model.position.y.toFixed(2);
  $("#p-z").value = model.position.z.toFixed(2);
  $("#r-x").value = THREE.MathUtils.radToDeg(model.rotation.x).toFixed(0);
  $("#r-y").value = THREE.MathUtils.radToDeg(model.rotation.y).toFixed(0);
  $("#r-z").value = THREE.MathUtils.radToDeg(model.rotation.z).toFixed(0);
  $("#s-uniform").value = model.scale.x.toFixed(2);
}
["p-x","p-y","p-z","r-x","r-y","r-z","s-uniform"].forEach(id=>{
  $("#"+id).addEventListener('change', ()=>{
    if (!model) return;
    const px=parseFloat($("#p-x").value||'0'), py=parseFloat($("#p-y").value||'0'), pz=parseFloat($("#p-z").value||'0');
    const rx=THREE.MathUtils.degToRad(parseFloat($("#r-x").value||'0'));
    const ry=THREE.MathUtils.degToRad(parseFloat($("#r-y").value||'0'));
    const rz=THREE.MathUtils.degToRad(parseFloat($("#r-z").value||'0'));
    const s=parseFloat($("#s-uniform").value||'1');
    model.position.set(px,py,pz); model.rotation.set(rx,ry,rz); model.scale.set(s,s,s);
  });
});
gizmo.addEventListener('objectChange', syncTransformInputsFromModel);

// Publish
function encodeHash(obj){ const json=JSON.stringify(obj); return '#'+btoa(unescape(encodeURIComponent(json))); }
const fileToDataURL = (file)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });

async function buildPayload(){
  if (!publishSrc || !model) throw new Error('Kein Modell im Viewport. Lade zuerst ein GLB/GLTF.');
  const s=model.scale.x;
  const pos=[model.position.x, model.position.y, model.position.z];
  const rot=[THREE.MathUtils.radToDeg(model.rotation.x), THREE.MathUtils.radToDeg(model.rotation.y), THREE.MathUtils.radToDeg(model.rotation.z)];
  const payload = {
    src: publishSrc, scale:s, position:pos, rotationDeg:rot,
    animSpeed: parseFloat($("#anim-speed").value||'1')||1,
    animLoop: $("#anim-loop").checked
  };
  const pick=$("#anim-name").value;
  if (pick==='*') payload.animation='*'; else payload.animName=pick;
  return payload;
}
async function makeSurfaceLink(){ const p=await buildPayload(); p.mode='surface'; return ($("#pub-viewer-url").value||'./viewer.html') + encodeHash(p); }
async function makeImageLink(){
  const p=await buildPayload(); p.mode='image';
  const f=$("#pub-image-file").files[0]; if(!f) throw new Error('Kein Trigger-Bild gewählt.');
  p.image = await fileToDataURL(f); p.imageWidthMeters = Number($("#pub-image-width").value||'0.2')||0.2;
  return ($("#pub-viewer-url").value||'./viewer.html') + encodeHash(p);
}

// QR
const QR_URL = "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
function ensureQR(){ return new Promise(res=>{ if (window.QRCode) return res(); const s=document.createElement('script'); s.src=QR_URL; s.onload=res; s.onerror=res; document.head.appendChild(s); }); }
async function drawQR(text){
  await ensureQR(); const cnv=$("#pub-qr"); if(!window.QRCode||!cnv){cnv.hidden=true;return;}
  const dataUrl = await window.QRCode.toDataURL(text,{errorCorrectionLevel:'L',width:280,margin:1});
  const img=new Image(); img.onload=()=>{cnv.width=img.width; cnv.height=img.height; const ctx=cnv.getContext('2d'); ctx.clearRect(0,0,cnv.width,cnv.height); ctx.drawImage(img,0,0);}; img.src=dataUrl;
}

// Publish UI
$("#pub-toggle").onclick = ()=> $("#pub-panel").style.display = ($("#pub-panel").style.display==='block'?'none':'block');
$("#pub-close").onclick = ()=> $("#pub-panel").style.display='none';
$("#pub-surface").onclick = async ()=>{ try{ const link=await makeSurfaceLink(); $("#pub-link").value=link; drawQR(link);}catch(e){ showErr(e.message);} };
$("#pub-image").onclick = async ()=>{ try{ const link=await makeImageLink(); $("#pub-link").value=link; drawQR(link);}catch(e){ showErr(e.message);} };

// Loop
const clock=new THREE.Clock();
function animate(){
  requestAnimationFrame(animate);
  const dt=clock.getDelta();
  if (mixer && mixer.timeScale!==0) mixer.update(dt);
  orbit.update();
  renderer.render(scene,camera);
}
</script>
</head>
<body>
  <header class="top">
    <b>AR Studio – Editor</b>
    <span class="muted">Viewport + Animation + Publish</span>
    <span style="flex:1"></span>
    <span class="muted small">Tipp: in Blender als <b>GLB</b> exportieren (bin+Texturen eingebettet).</span>
  </header>

  <main class="app">
    <aside class="sidebar">
      <div class="field">
        <label class="small">GLB/GLTF Datei</label>
        <input id="f-file" type="file" accept=".glb,.gltf"/>
        <button id="demo-load" style="margin-top:6px">Demo laden (Astronaut)</button>
      </div>
      <div class="field">
        <label class="small">oder GLB/GLTF URL</label>
        <input id="f-url" type="text" placeholder="https://…/model.glb"/>
        <div class="row">
          <button id="btn-load">Laden</button>
          <button id="btn-probe">Animationen erkennen</button>
        </div>
        <div class="small muted">Extern: CORS muss <code>Access-Control-Allow-Origin: *</code> setzen.</div>
      </div>

      <div class="hline"></div>

      <div class="field">
        <label class="small">Animation</label>
        <select id="anim-name"><option value="*">alle</option></select>
        <div class="row">
          <button id="anim-play">Play</button>
          <button id="anim-pause">Pause</button>
          <label class="row" style="gap:6px"><span class="small">Speed</span><input id="anim-speed" type="number" step="0.1" value="1.0"/></label>
        </div>
        <label class="row" style="gap:8px;align-items:center"><input id="anim-loop" type="checkbox" checked/><span class="small">Loop</span></label>
      </div>

      <div class="hline"></div>

      <div class="field">
        <label class="small">Gizmo</label>
        <div class="row">
          <button data-gizmo="translate">Move</button>
          <button data-gizmo="rotate">Rotate</button>
          <button data-gizmo="scale">Scale</button>
        </div>
      </div>

      <div class="field">
        <label class="small">Transform</label>
        <div class="row"><label class="small" style="width:40px">Pos</label>
          <input id="p-x" type="number" step="0.01" value="0"><input id="p-y" type="number" step="0.01" value="0"><input id="p-z" type="number" step="0.01" value="0">
        </div>
        <div class="row"><label class="small" style="width:40px">Rot°</label>
          <input id="r-x" type="number" step="1" value="0"><input id="r-y" type="number" step="1" value="0"><input id="r-z" type="number" step="1" value="0">
        </div>
        <div class="row"><label class="small" style="width:40px">Scale</label>
          <input id="s-uniform" type="number" step="0.01" value="1">
        </div>
      </div>

      <div class="hline"></div>

      <div class="field">
        <label class="row" style="gap:8px;align-items:center"><input id="grid-toggle" type="checkbox" checked><span class="small">Grid & Achsen anzeigen</span></label>
        <div class="row"><button id="cam-reset">Kamera reset</button></div>
      </div>

      <div class="hline"></div>

      <div class="small muted">Publish unten rechts – erzeugt Links für Surface / Image AR.</div>
    </aside>

    <section id="viewport" aria-label="3D Viewport">
      <div class="toolbar"><span class="chip" id="modelName">Kein Modell</span></div>
      <div id="canvasWrap"></div>
      <div id="dropHint">GLB hierher ziehen …</div>
      <div id="status" class="small muted">Bereit…</div>
    </section>
  </main>

  <!-- Publish Panel -->
  <button id="pub-toggle" title="Publish (Surface/Image AR)">Publish</button>
  <aside id="pub-panel" role="dialog" aria-modal="false" aria-label="Publish">
    <header>
      <b>Publish – WebAR Link</b>
      <div style="flex:1"></div>
      <button id="pub-close" title="Schließen" style="padding:6px 8px;border-radius:8px">✕</button>
    </header>
    <div class="body">
      <label>Viewer URL
        <input id="pub-viewer-url" type="text" value="../viewer.html" placeholder="./viewer.html">
      </label>

      <div style="border:1px solid var(--border);border-radius:12px;padding:10px">
        <h4 style="margin:0 0 8px 0;font-size:13px;color:#cbd5e1">Quelle wählen</h4>
        <div class="row"><button id="pub-surface">Surface-AR Link</button><button id="pub-image">Image-AR Link</button></div>
        <div class="row" style="margin-top:8px">
          <input id="pub-image-file" type="file" accept="image/*">
          <label>Bildbreite (m)<input id="pub-image-width" type="number" step="0.01" min="0.05" value="0.20"></label>
        </div>
      </div>

      <label>Link <input id="pub-link" type="text" readonly placeholder="Hier erscheint der Link…"></label>
      <canvas id="pub-qr" width="0" height="0"></canvas>
      <div class="small">Scanne den QR-Code oder kopiere den Link (HTTPS!).</div>
    </div>
  </aside>

  <div id="err"></div>
</body>
</html>
