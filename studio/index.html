<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor with Publish (Standalone, alles inline) – mit Animation</title>
  <style>
    :root { --bg:#0e1116; --panel:#0b1323; --muted:#94a3b8; --fg:#e9ecf5; --border:#24314a; --accent:#223049; }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font:14px/1.45 system-ui,Segoe UI,Arial}
    header.top{display:flex;align-items:center;gap:12px;padding:12px;background:var(--panel);border-bottom:1px solid var(--border)}
    header.top b{font-weight:600}
    header.top .muted{color:var(--muted)}
    main{padding:12px}
    .hidden{display:none!important}

    /* Publish Panel */
    #pub-toggle{position:fixed;right:16px;bottom:16px;z-index:99998;background:#1f2a44;color:#fff;
      border:1px solid #2a3347;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    #pub-panel{position:fixed;right:16px;bottom:66px;z-index:99999;width:360px;max-width:92vw;background:#0b1323f2;color:#e9ecf5;
      border:1px solid #2a3347;border-radius:14px;box-shadow:0 20px 48px rgba(0,0,0,.35);display:none}
    #pub-panel header{display:flex;align-items:center;gap:8px;padding:10px 12px;border-bottom:1px solid var(--border)}
    #pub-panel header b{font:600 14px/1.3 system-ui,Segoe UI,Arial}
    #pub-panel .body{padding:10px 12px;display:grid;gap:10px}
    #pub-panel label{display:flex;flex-direction:column;gap:4px;font-size:12px;opacity:.95}
    #pub-panel input[type="text"], #pub-panel input[type="number"]{background:#0e1628;border:1px solid #27334b;color:#e9ecf5;
      border-radius:8px;padding:8px}
    #pub-panel .row{display:flex;gap:8px;align-items:center}
    #pub-panel .row > *{flex:1}
    #pub-panel button{background:#223049;border:1px solid #2a3347;color:#e9ecf5;border-radius:10px;padding:8px 10px;cursor:pointer}
    #pub-panel .muted{opacity:.8;font-size:12px}
    #pub-qr{display:block;margin:6px auto 0 auto; background:#fff; border-radius:8px; max-width:100%}

    /* Manual config section */
    .section{border:1px solid var(--border); border-radius:12px; padding:10px}
    .section h4{margin:0 0 8px 0; font-size:13px; color:#cbd5e1}
    .grid{display:grid;grid-template-columns:1fr 1fr; gap:8px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr; gap:8px}
    .small{font-size:12px;color:#a6b4cf}
    .notice{padding:8px;border:1px dashed var(--border); border-radius:10px; background:#0b1323cc; color:#cbd5e1}
    code{background:#0b1220;padding:0 4px;border-radius:4px}
  </style>

  <!-- Kleines THREE-Modul nur, um Animations-Namen aus GLB/GLTF zu lesen -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
  <script type="module">
    import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
    const loader = new GLTFLoader();
    async function probeAnimations(src){
      return new Promise((resolve,reject)=>{
        loader.load(src, gltf=>{
          const names = (gltf.animations||[]).map(c=>c.name||'');
          resolve(names);
        }, undefined, err=>reject(err));
      });
    }
    // für non-module-Script verfügbar machen
    window.__probeAnimations = probeAnimations;
  </script>
</head>
<body>
  <header class="top">
    <b>Editor + Publish Panel</b>
    <span class="muted">Mit Animation (Clip-Erkennung aus GLB/GLTF)</span>
    <span style="flex:1"></span>
    <a href="#" id="demoSelect" style="color:#a5b4fc;text-decoration:underline">Demo: Auswahl simulieren</a>
  </header>
  <main>
    <div class="notice">
      <b>Hinweis:</b> Dieses Standalone-File enthält das Publish-Panel inkl. <b>manueller Szenenkonfiguration</b> (mit Animation).<br>
      Falls deine echte Editor-App <code>state.objects</code> &amp; <code>state.selectedId</code> bereitstellt, wird das bevorzugt genutzt.
    </div>

    <div class="section">
      <h4>Manuelle Szene (falls kein Editor-State)</h4>

      <div class="grid">
        <label>GLB/GLTF Datei (optional)
          <input id="m-file" type="file" accept=".glb,.gltf">
        </label>
        <label>GLB/GLTF URL (oder Data URL)
          <input id="m-src" type="text" placeholder="https://.../model.glb">
        </label>
      </div>

      <div class="grid-3" style="margin-top:8px">
        <label>Scale<input id="m-scale" type="number" step="0.01" value="1"></label>
        <label>Audio URL<input id="m-audio" type="text" placeholder="optional"></label>
        <label>Anim Speed<input id="m-anim-speed" type="number" step="0.1" value="1.0"></label>
      </div>

      <div class="grid-3">
        <label>Rot X°<input id="m-rx" type="number" step="1" value="0"></label>
        <label>Rot Y°<input id="m-ry" type="number" step="1" value="0"></label>
        <label>Rot Z°<input id="m-rz" type="number" step="1" value="0"></label>
      </div>
      <div class="grid-3">
        <label>Pos X<input id="m-px" type="number" step="0.01" value="0"></label>
        <label>Pos Y<input id="m-py" type="number" step="0.01" value="0"></label>
        <label>Pos Z<input id="m-pz" type="number" step="0.01" value="0"></label>
      </div>

      <div class="grid" style="margin-top:8px">
        <label>Animation (Clip)
          <select id="m-anim-name">
            <option value="*">alle</option>
            <!-- dynamisch: Clipnamen -->
          </select>
        </label>
        <label class="small" style="display:flex;align-items:center;gap:8px">
          <input id="m-anim-loop" type="checkbox" checked> Loop
        </label>
      </div>

      <div class="row" style="margin-top:8px; gap:8px; display:flex">
        <button id="m-probe" style="padding:8px 10px;border-radius:10px;border:1px solid #2a3347;background:#223049;color:#e9ecf5">Animationen erkennen</button>
        <label class="small" style="align-self:center">Liest Clipnamen direkt aus deinem Blender-Export (GLB/GLTF).</label>
      </div>

      <label class="small" style="margin-top:8px"><input id="m-enable" type="checkbox"> Manuelle Szene aktivieren (wenn kein Editor-Objekt gewählt ist)</label>
    </div>
  </main>

  <!-- ======== PUBLISH PANEL ======== -->
  <button id="pub-toggle" title="Publish (Surface/Image AR)">Publish</button>
  <aside id="pub-panel" role="dialog" aria-modal="false" aria-label="Publish">
    <header>
      <b>Publish – WebAR Link</b>
      <div style="flex:1"></div>
      <button id="pub-close" title="Schließen" style="padding:6px 8px;border-radius:8px">✕</button>
    </header>
    <div class="body">
      <label>Viewer URL (HTTPS empfohlen)
        <input id="pub-viewer-url" type="text" value="./viewer.html" placeholder="./viewer.html">
      </label>

      <div class="section">
        <h4>Quelle wählen</h4>
        <div class="row">
          <button id="pub-surface">Surface-AR Link</button>
          <button id="pub-image">Image-AR Link</button>
        </div>
        <div class="row">
          <input id="pub-image-file" type="file" accept="image/*">
          <label>Bildbreite (m)
            <input id="pub-image-width" type="number" step="0.01" min="0.05" value="0.20">
          </label>
        </div>
      </div>

      <label>Link
        <input id="pub-link" type="text" readonly placeholder="Hier erscheint der Link…">
      </label>
      <canvas id="pub-qr" width="0" height="0"></canvas>
      <div class="small">Scanne den QR-Code oder kopiere den Link. Für AR ist HTTPS erforderlich.</div>
    </div>
  </aside>

  <script>
    // --- optional: kleine Demo-Auswahl ---
    document.getElementById('demoSelect').addEventListener('click', (e)=>{
      e.preventDefault();
      window.state = {
        selectedId: 'demo1',
        objects: [{
          id: 'demo1',
          url: 'https://modelviewer.dev/shared-assets/models/Astronaut.glb',
          group: { position:{x:0,y:0,z:0}, rotation:{x:0,y:0,z:0}, scale:{x:1,y:1,z:1} },
          animIndex: 0,
          animName: 'Idle',
          audioURL: ''
        }]
      };
      alert('Demo-Auswahl gesetzt. Öffne das Publish-Panel.');
    });
  </script>

  <script>
  (function(){
    const $ = (s)=> document.querySelector(s);
    const on = (el, ev, fn)=> el && el.addEventListener(ev, fn);

    // QR lib (lazy)
    const QR_URL = "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js";
    function ensureQRLib(){
      return new Promise((resolve)=>{
        if (window.QRCode) return resolve();
        const s = document.createElement('script');
        s.src = QR_URL; s.async = true; s.onload = resolve; s.onerror = resolve;
        document.head.appendChild(s);
      });
    }
    async function drawQR(text){
      await ensureQRLib();
      const cnv = $("#pub-qr");
      if(!window.QRCode || !cnv){ cnv.hidden=true; return; }
      try{
        const dataUrl = await window.QRCode.toDataURL(text, { errorCorrectionLevel:'L', width: 280, margin:1 });
        const img = new Image();
        img.onload = ()=>{
          cnv.width = img.width; cnv.height = img.height;
          const ctx = cnv.getContext('2d'); ctx.clearRect(0,0,cnv.width,cnv.height); ctx.drawImage(img, 0, 0);
          cnv.hidden = false;
        };
        img.src = dataUrl;
      }catch(e){ cnv.hidden=true; }
    }

    function encodeHash(obj){
      const json = JSON.stringify(obj);
      return '#' + btoa(unescape(encodeURIComponent(json)));
    }

    // Helpers
    const fileToBase64 = file => new Promise((res,rej)=>{
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
    });
    const snapshotTransform = group => ({
      position:[group.position.x, group.position.y, group.position.z],
      rotationDeg:[group.rotation.x*180/Math.PI, group.rotation.y*180/Math.PI, group.rotation.z*180/Math.PI],
      scale: group.scale.x
    });

    // --- Animationen erkennen (GLB/GLTF) ---
    async function probeAnimNamesFromInputs(){
      const f = $('#m-file')?.files?.[0];
      let src = '';
      if (f){ src = await fileToBase64(f); }
      else { src = ($('#m-src').value||'').trim(); }
      if (!src){ alert('Bitte zuerst GLB/GLTF Datei auswählen oder URL eintragen.'); return; }

      try{
        const names = await window.__probeAnimations(src);
        const sel = $('#m-anim-name');
        const keep = sel.value;
        sel.innerHTML = '<option value="*">alle</option>';
        if (Array.isArray(names) && names.length){
          names.forEach(n=> sel.insertAdjacentHTML('beforeend', `<option value="${n}">${n||'(unbenannt)'}</option>`));
        }
        if ([...sel.options].some(o=>o.value===keep)){ sel.value = keep; }
      }catch(e){
        alert('Konnte Animationen nicht lesen: '+e.message+'\nTipp: GLB bevorzugen; GLTF mit externen Dateien ist per Data-URL schwierig.');
      }
    }
    on($('#m-probe'), 'click', probeAnimNamesFromInputs);
    on($('#m-file'), 'change', probeAnimNamesFromInputs);
    on($('#m-src'), 'change', probeAnimNamesFromInputs);

    // Build Payload aus Editor-Auswahl ODER manueller Szene
    async function buildScenePayload(){
      // 1) Echte Editor-State-Quelle (falls vorhanden)
      if(window.state && Array.isArray(state.objects)){
        const sid = state.selectedId;
        const rec = state.objects.find(o=>o.id===sid);
        if(sid && rec && rec.group){
          let src = rec.url || rec.src || null;
          if(!src && rec.file){ src = await fileToBase64(rec.file); }
          if(!src) throw new Error('Keine GLB/GLTF-Quelle beim Objekt (Editor) gefunden');

          const t = snapshotTransform(rec.group);
          const payload = {
            src, scale:t.scale, rotationDeg:t.rotationDeg, position:t.position,
            animIndex: (typeof rec.animIndex==='number') ? rec.animIndex : 0,
            animSpeed: (typeof rec.animSpeed==='number') ? rec.animSpeed : 1.0,
            animLoop:  (typeof rec.animLoop==='boolean') ? rec.animLoop : true
          };
          if (typeof rec.animName==='string' && rec.animName){ payload.animName = rec.animName; }
          return payload;
        }
      }
      // 2) Manuelle Szene
      if($('#m-enable')?.checked){
        const f = $('#m-file')?.files?.[0];
        const fromFile = f ? await fileToBase64(f) : null;
        const src = fromFile || ($('#m-src').value||'').trim();
        if(!src) throw new Error('Manuelle Szene: GLB/GLTF Quelle fehlt (Datei oder URL)');
        const scale = parseFloat($('#m-scale').value||'1')||1;
        const audio = ($('#m-audio').value||'').trim() || null;
        const rx = parseFloat($('#m-rx').value||'0')||0;
        const ry = parseFloat($('#m-ry').value||'0')||0;
        const rz = parseFloat($('#m-rz').value||'0')||0;
        const px = parseFloat($('#m-px').value||'0')||0;
        const py = parseFloat($('#m-py').value||'0')||0;
        const pz = parseFloat($('#m-pz').value||'0')||0;

        const animSel = $('#m-anim-name').value || '*';
        const speed = parseFloat($('#m-anim-speed').value||'1')||1;
        const loop  = $('#m-anim-loop').checked;

        const payload = {
          src, scale, rotationDeg:[rx,ry,rz], position:[px,py,pz],
          animSpeed: speed, animLoop: loop
        };
        if (animSel === '*'){ payload.animation='*'; }
        else { payload.animName = animSel; }
        if (audio) payload.audio = audio;
        return payload;
      }
      throw new Error('Kein Objekt gewählt und manuelle Szene nicht aktiviert.');
    }

    function baseViewerURL(){
      return $("#pub-viewer-url")?.value?.trim() || "./viewer.html";
    }

    async function makeSurfaceARLink(){
      const p = await buildScenePayload();
      p.mode = 'surface';
      return baseViewerURL() + encodeHash(p);
    }

    async function makeImageARLink(file, widthMeters){
      if(!file) throw new Error('Kein Trigger-Bild gewählt');
      const imgData = await fileToBase64(file);
      const p = await buildScenePayload();
      p.mode = 'image';
      p.image = imgData;
      p.imageWidthMeters = Number(widthMeters)||0.2;
      return baseViewerURL() + encodeHash(p);
    }

    // UI
    const toggle = $("#pub-toggle");
    const panel = $("#pub-panel");
    on(toggle, 'click', ()=> { panel.style.display = (panel.style.display==='none'||!panel.style.display) ? 'block' : 'none'; });
    on($("#pub-close"), 'click', ()=> { panel.style.display='none'; });

    on($("#pub-surface"), 'click', async ()=>{
      const out = $("#pub-link");
      try{
        const link = await makeSurfaceARLink();
        out.value = link; drawQR(link);
      }catch(e){ out.value = e.message; }
    });

    on($("#pub-image"), 'click', async ()=>{
      const out = $("#pub-link");
      try{
        const file = $("#pub-image-file")?.files?.[0];
        const width = $("#pub-image-width")?.value || '0.2';
        const link = await makeImageARLink(file, width);
        out.value = link; drawQR(link);
      }catch(e){ out.value = e.message; }
    });

    // Close on Escape
    window.addEventListener('keydown', (e)=>{
      if(e.key==='Escape' && panel.style.display==='block'){ panel.style.display='none'; }
    }, true);
  })();
  </script>
</body>
</html>
