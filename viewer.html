<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>WebAR Viewer (Surface & Image) – mit Animation</title>
<style>
  :root{color-scheme:dark}
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;background:#000;color:#fff;font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  #ui{position:fixed;inset:0;pointer-events:none;z-index:10}
  #top{position:absolute;right:max(12px,env(safe-area-inset-right));top:max(12px,env(safe-area-inset-top));display:flex;gap:8px}
  .btn{pointer-events:auto;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
  #hint{position:absolute;left:50%;bottom:max(20px,env(safe-area-inset-bottom));transform:translateX(-50%);pointer-events:auto;
        background:rgba(0,0,0,.55);padding:10px 12px;border-radius:12px;font-size:13px}
  #enter{pointer-events:auto;position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
         padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,.25);background:#111;color:#fff}
  #err{position:fixed;left:12px;top:12px;z-index:99;background:#b00020;padding:8px 10px;border-radius:8px;display:none;font:12px/1.35 monospace;max-width:min(92vw,680px);white-space:pre-wrap}
  #thumb{position:absolute;right:max(12px,env(safe-area-inset-right));bottom:max(76px,env(safe-area-inset-bottom));width:96px;height:96px;
         background:#000;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,.2);display:none}
  #thumb img{width:100%;height:100%;object-fit:contain;background:#000}
</style>
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>
</head>
<body>
<div id="err"></div>
<div id="ui" aria-hidden="false">
  <div id="top">
    <button id="reset" class="btn" style="display:none">Neu platzieren</button>
  </div>
  <div id="hint">Tippe „Start AR“</div>
  <button id="enter">Start AR</button>
  <div id="thumb"><img id="thumbImg" alt=""></div>
</div>

<script type="module">
import * as THREE from 'three';
import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';

const $ = s => document.querySelector(s);
const showErr = (m)=>{ const el=$("#err"); el.textContent=m; el.style.display='block'; console.error(m); };

// ---- Hash-Payload ----
function parseHash(){
  const h = location.hash?.slice(1)||'';
  if(!h) throw new Error('Kein Payload im Hash (#…). Bitte Link aus dem Editor verwenden.');
  const json = decodeURIComponent(escape(atob(h)));
  const p = JSON.parse(json);
  if(!p.mode || !p.src) throw new Error('Payload unvollständig (mode/src fehlen).');
  return p;
}
const P = (()=>{ try{ return parseHash(); }catch(e){ showErr('Payload-Fehler: '+e.message); throw e; } })();

// ---- THREE/WebXR Setup ----
let camera, scene, renderer, reticle, controller;
let hitTestSource = null, hitTestSourceRequested = false;
let model=null, mixer=null, clips=[];
const clock = new THREE.Clock();

function initThree(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera();
  scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.1));
  const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(0,6,0); scene.add(dir);

  renderer = new THREE.WebGLRenderer({alpha:true, antialias:false, powerPreference:'low-power'});
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.0;
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, 1.6));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.xr.enabled = true;
  document.body.appendChild(renderer.domElement);
  addEventListener('resize', ()=>renderer.setSize(innerWidth, innerHeight));
}

function makeReticle(){
  const ring = new THREE.RingGeometry(0.07, 0.085, 48).rotateX(-Math.PI/2);
  const mat  = new THREE.MeshBasicMaterial({color:0x00ffff});
  reticle = new THREE.Mesh(ring, mat);
  reticle.matrixAutoUpdate = false;
  reticle.visible = false;
  scene.add(reticle);
}

function playAnimations(){
  if (!mixer || !clips.length) return;
  const speed = Number(P.animSpeed||1) || 1;
  mixer.timeScale = speed;

  // Auswahl-Logik: animName > animation="*" > animIndex > default 0
  let actions=[];
  if (P.animation==='*' || P.animAll===true){
    actions = clips.map(c=>mixer.clipAction(c));
  } else if (typeof P.animName==='string'){
    const c = clips.find(c=>c.name===P.animName);
    if (c) actions=[mixer.clipAction(c)];
  } else {
    const idx = Math.max(0, Math.min(clips.length-1, parseInt(P.animIndex??0,10)));
    actions=[mixer.clipAction(clips[idx])];
  }
  const loop = (P.animLoop===false) ? THREE.LoopOnce : THREE.LoopRepeat;
  actions.forEach(a=>{ a.clampWhenFinished = (loop===THREE.LoopOnce); a.setLoop(loop, Infinity).play(); });
}

function loadModel(atMatrix=null){
  return new Promise((resolve,reject)=>{
    const loader = new GLTFLoader();
    loader.load(P.src, (gltf)=>{
      model = gltf.scene;
      clips = gltf.animations||[];
      const s = Number(P.scale||1); model.scale.set(s,s,s);
      const [rx=0,ry=0,rz=0] = P.rotationDeg||[];
      model.rotation.set(THREE.MathUtils.degToRad(rx), THREE.MathUtils.degToRad(ry), THREE.MathUtils.degToRad(rz));
      if (atMatrix){
        model.position.setFromMatrixPosition(atMatrix);
      } else if (P.position){
        const [px=0,py=0,pz=0] = P.position; model.position.set(px,py,pz);
      }
      scene.add(model);
      if (clips.length){
        mixer = new THREE.AnimationMixer(model);
        playAnimations();
      }
      resolve();
    }, undefined, reject);
  });
}

// ---- Surface AR ----
async function startSurfaceAR(){
  if (!navigator.xr) throw new Error('WebXR nicht verfügbar.');
  if (!await navigator.xr.isSessionSupported('immersive-ar')) throw new Error('Dein Gerät/Browser unterstützt kein WebXR-AR.');

  const variants = [
    { requiredFeatures:['hit-test'], optionalFeatures:['dom-overlay','local-floor'], overlay:true },
    { requiredFeatures:['hit-test'], optionalFeatures:['local-floor'], overlay:false }
  ];
  let session=null,lastErr=null;
  for (const v of variants){
    try{
      const init = { requiredFeatures:v.requiredFeatures, optionalFeatures:v.optionalFeatures };
      if (v.overlay) init.domOverlay = { root: $("#ui") };
      session = await navigator.xr.requestSession('immersive-ar', init);
      break;
    }catch(e){ lastErr=e; }
  }
  if (!session) throw new Error('AR-Session konnte nicht gestartet werden: '+(lastErr?.message||'unbekannt'));

  try{ renderer.xr.setReferenceSpaceType('local-floor'); }catch{}
  await renderer.xr.setSession(session);

  controller = renderer.xr.getController(0);
  controller.addEventListener('select', async ()=>{
    if (!reticle?.visible) return;
    if (!model){ await loadModel(reticle.matrix); }
    else { model.position.setFromMatrixPosition(reticle.matrix); model.visible = true; }
    $("#hint").textContent = 'Platziert. „Neu platzieren“ möglich.';
    $("#reset").style.display = 'inline-block';
  });
  scene.add(controller);

  session.addEventListener('end', ()=>{
    hitTestSourceRequested=false; hitTestSource=null;
    if (model) model.visible=false;
    if (reticle) reticle.visible=false;
    $("#reset").style.display='none';
    $("#hint").textContent='Session beendet.';
  });

  makeReticle();
  $("#enter").style.display='none';
  $("#hint").textContent = 'Bewege das Gerät, bis der Ring stabil ist. Tippe, um zu platzieren.';

  renderer.setAnimationLoop((t, frame)=>{
    const dt = clock.getDelta(); if (mixer) mixer.update(dt);
    if (frame){
      const referenceSpace = renderer.xr.getReferenceSpace();
      const session = renderer.xr.getSession();
      if (!hitTestSourceRequested){
        session.requestReferenceSpace('viewer').then(viewerSpace=>{
          session.requestHitTestSource({space:viewerSpace}).then(src=>{ hitTestSource = src; });
        }).catch(e=>showErr('Hit-Test nicht verfügbar: '+e.message));
        hitTestSourceRequested = true;
      }
      if (hitTestSource){
        const results = frame.getHitTestResults(hitTestSource);
        if (results.length){
          const hit = results[0], pose = hit.getPose(referenceSpace);
          if (pose){
            reticle.visible = !model || !model.visible;
            reticle.matrix.fromArray(pose.transform.matrix);
          }
        } else { reticle.visible = false; }
      }
    }
    renderer.render(scene, camera);
  });

  $("#reset").onclick = ()=>{
    if (model) model.visible=false;
    $("#hint").textContent = 'Bewege das Gerät, bis der Ring stabil ist. Tippe, um zu platzieren.';
  };
}

// ---- Image AR (WebXR Image Tracking) ----
async function startImageAR(){
  if (!navigator.xr) throw new Error('WebXR nicht verfügbar.');
  if (!await navigator.xr.isSessionSupported('immersive-ar')) throw new Error('Dein Gerät/Browser unterstützt kein WebXR-AR.');

  if (!P.image) throw new Error('Kein Trigger-Bild im Payload vorhanden.');
  const imgBlob = await (await fetch(P.image)).blob();
  const imgBitmap = await createImageBitmap(imgBlob);
  const widthMeters = Number(P.imageWidthMeters||0.2);

  const session = await navigator.xr.requestSession('immersive-ar', {
    requiredFeatures: ['image-tracking'],
    optionalFeatures: ['dom-overlay','local-floor'],
    trackedImages: [{ image: imgBitmap, widthInMeters: widthMeters }],
    domOverlay: { root: $("#ui") }
  });
  try{ renderer.xr.setReferenceSpaceType('local-floor'); }catch{}
  await renderer.xr.setSession(session);

  $("#enter").style.display='none';
  $("#hint").textContent = 'Suche das Bild. Bei Erkennung erscheint das Modell.';
  $("#thumbImg").src = P.image; $("#thumb").style.display='block';

  const referenceSpace = await session.requestReferenceSpace('local');

  await loadModel(); model.visible = false;

  session.addEventListener('end', ()=>{
    $("#hint").textContent='Session beendet.';
    $("#thumb").style.display='none';
  });

  renderer.setAnimationLoop((t, frame)=>{
    const dt = clock.getDelta(); if (mixer) mixer.update(dt);
    if (frame){
      const results = frame.getImageTrackingResults?.() || [];
      for (const res of results){
        const pose = res.getPose(referenceSpace);
        if (pose){
          model.matrix.fromArray(pose.transform.matrix);
          model.matrix.decompose(model.position, model.quaternion, model.scale);
          const tracked = (res.trackingState==='tracked' || res.trackingState==='emulated');
          model.visible = tracked;
          $("#hint").textContent = tracked ? 'Bild erkannt.' : 'Suche das Bild…';
        }
      }
    }
    renderer.render(scene, camera);
  });
}

// ---- Start ----
initThree();
$("#enter").addEventListener('click', async ()=>{
  try{
    if (P.mode === 'surface') await startSurfaceAR();
    else if (P.mode === 'image') await startImageAR();
    else throw new Error('Unbekannter Modus: '+P.mode);
  }catch(e){ showErr(e.message); }
});
</script>
</body>
</html>
